<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RUNIC - Analyseur ATS + ROME 4.0</title>

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Montserrat:wght@600;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>

    <style>
        :root {
            --primary: #667eea; --primary-dark: #764ba2; --success: #28a745; --danger: #dc3545;
            --gray-100: #f8f9ff; --gray-200: #e2e8f0; --gray-600: #6c757d; --radius: 16px; --shadow: 0 8px 25px rgba(102,126,234,.2);
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body {font-family:'Roboto',sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);padding:20px;color:#333;min-height:100vh;}
        .container {max-width:1200px;margin:0 auto;background:white;border-radius:var(--radius);box-shadow:0 20px 60px rgba(0,0,0,.3);overflow:hidden;}
        header {background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);color:white;padding:40px;text-align:center;}
        header h1 {font-family:'Montserrat',sans-serif;font-size:clamp(2.5em,7vw,4em);font-weight:800;}
        header p {font-size:1.3em;margin-top:10px;opacity:.95;}

        main {padding:40px;}

        .upload-section, .jd-section, .badges-section {
            padding:30px;border:2px solid var(--primary);border-radius:var(--radius);background:#fff;margin-bottom:30px;box-shadow:var(--shadow);
        }
        .upload-section h2, .jd-section h2, .badges-section h2 {color:var(--primary);margin-bottom:20px;font-family:'Montserrat',sans-serif;font-size:1.6em;}

        .upload-btn, .jd-btn, .badge-add-btn {
            background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);color:white;padding:14px 32px;border:none;border-radius:30px;
            cursor:pointer;font-weight:700;font-size:1.1em;transition:all .3s;box-shadow:0 6px 20px rgba(102,126,234,.4);
        }
        .upload-btn:hover, .jd-btn:hover, .badge-add-btn:hover {transform:translateY(-3px);box-shadow:0 10px 30px rgba(102,126,234,.5);}

        textarea {width:100%;padding:15px;border:2px solid var(--gray-200);border-radius:12px;min-height:160px;font-size:1.1em;}
        textarea:focus {outline:none;border-color:var(--primary);box-shadow:0 0 0 4px rgba(102,126,234,.15);}

        .badge-item {display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin:15px 0;padding:15px;background:var(--gray-100);border-radius:12px;}
        .badge-item input {flex:1;min-width:200px;padding:12px;border:1px solid var(--gray-200);border-radius:10px;font-size:1em;}
        .badge-remove {color:var(--danger);cursor:pointer;font-size:1.6em;transition:all .3s;}
        .badge-remove:hover {transform:scale(1.2);}

        .loading {text-align:center;padding:80px;display:none;}
        .spinner {width:70px;height:70px;border:8px solid #f3f3f3;border-top:8px solid var(--primary);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 30px;}
        @keyframes spin {to{transform:rotate(360deg)}}

        .result-section {display:none;padding:40px;background:var(--gray-100);border-radius:20px;}
        .action-buttons {text-align:center;margin:60px 0;display:flex;gap:20px;justify-content:center;flex-wrap:wrap;}
        .btn {padding:18px 40px;border-radius:35px;font-size:1.2em;font-weight:700;display:flex;align-items:center;gap:15px;box-shadow:0 8px 25px rgba(0,0,0,.3);transition:all .3s;border:none;cursor:pointer;background:var(--primary);color:white;}
        .btn:hover {transform:translateY(-5px);}

        /* NOUVEAU: Section r√©sultats ROME visible */
        .rome-results {margin:30px 0;padding:25px;background:white;border-radius:16px;box-shadow:var(--shadow);border-left:5px solid var(--primary);}
        .rome-results h3 {color:var(--primary);font-family:'Montserrat',sans-serif;font-size:1.8em;margin-bottom:20px;}
        .rome-item {display:flex;justify-content:space-between;align-items:center;padding:15px;margin:10px 0;background:var(--gray-100);border-radius:12px;transition:all .3s;}
        .rome-item:hover {background:var(--primary);color:white;transform:translateX(5px);}
        .rome-score {font-weight:700;font-size:1.3em;color:var(--success);}

        /* NOUVEAU: Radar softskills visible */
        .radar-preview {max-width:500px;margin:30px auto;background:white;padding:25px;border-radius:20px;box-shadow:var(--shadow);}
        .radar-preview canvas {max-width:100%;height:400px !important;}

        .pdf-container {display:none;background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);color:white;padding:40px;font-family:'Roboto',sans-serif;}
        .pdf-container h1 {font-family:'Montserrat',sans-serif;font-size:2.8em;text-align:center;margin-bottom:20px;}
        .pdf-container .subtitle {font-size:1.4em;text-align:center;font-style:italic;margin-bottom:40px;max-width:90%;margin-left:auto;margin-right:auto;}
        .pdf-container .radar {max-width:600px;margin:40px auto;background:white;padding:30px;border-radius:20px;}
        .pdf-container .section {margin:40px 0;}
        .pdf-container .section h3 {font-size:1.8em;margin-bottom:20px;text-align:center;}
        .pdf-container ul {list-style:none;max-width:800px;margin:0 auto;}
        .pdf-container li {margin:15px 0;padding:20px;background:rgba(255,255,255,0.2);border-radius:12px;font-size:1.1em;}
        .pdf-container .footer {text-align:center;margin-top:80px;padding-top:20px;border-top:1px solid rgba(255,255,255,0.3);font-size:1em;opacity:0.9;}

        .info-modal {display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:1000;align-items:center;justify-content:center;}
        .info-modal-content {background:white;border-radius:20px;max-width:700px;width:90%;padding:40px;box-shadow:0 30px 80px rgba(0,0,0,.4);text-align:center;}
        .info-modal-content input, .info-modal-content textarea {width:100%;margin:15px 0;padding:15px;border:2px solid var(--gray-200);border-radius:10px;font-size:1.2em;}

        .error {color:var(--danger);text-align:center;padding:20px;background:#ffe6e6;border-radius:12px;margin:20px 0;}
        .success {color:var(--success);text-align:center;padding:20px;background:#e6f7e6;border-radius:12px;margin:20px 0;}
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>RUNIC</h1>
        <p>Analyseur ATS + ROME 4.0 ‚Ä¢ Cr√©√© par C√©dric Odin</p>
    </header>

    <main>
        <div class="upload-section">
            <h2>Chargez votre CV</h2>
            <input type="file" id="fileInput" accept=".pdf,.docx,.txt" style="display:none;">
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">S√©lectionner le CV</button>
        </div>

        <div class="jd-section">
            <h2>Offre d'Emploi (optionnel)</h2>
            <textarea id="jdText" placeholder="Collez ici le texte de l'offre pour analyser la compatibilit√©"></textarea>
        </div>

        <div class="badges-section">
            <h2>üèÖ Open Badges (optionnel)</h2>
            <button class="badge-add-btn" onclick="addBadge()">+ Ajouter un badge</button>
            <div id="badgesList"></div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Analyse en cours...</p>
        </div>

        <div class="result-section" id="resultSection"></div>
    </main>
</div>

<!-- Modale personnalisation PDF -->
<div class="info-modal" id="infoModal">
    <div class="info-modal-content">
        <h2>Personnalisez votre PDF</h2>
        <input type="text" id="pdfName" placeholder="Nom Pr√©nom">
        <textarea id="pdfHook" placeholder="Phrase d'accroche"></textarea>
        <button class="btn" onclick="generateSelectedPDF()">G√©n√©rer</button>
        <button class="btn" style="background:var(--gray-600);margin-left:10px;" onclick="closeModal()">Annuler</button>
    </div>
</div>

<!-- Conteneurs PDF cach√©s -->
<div id="passeportPDF" class="pdf-container">
    <h1>Le passeport de competence</h1>
    <div class="subtitle" id="passeportSubtitle"></div>
    <div class="radar"><canvas id="passeportRadar"></canvas></div>
    <div class="section badges">
        <h3>Open Badges</h3>
        <ul id="passeportBadges"></ul>
    </div>
    <div class="section metiers">
        <h3>M√©tiers pertinents</h3>
        <ul id="passeportMetiers"></ul>
    </div>
    <div class="footer">RUNIC ‚Ä¢ Cr√©√© par C√©dric Odin</div>
</div>

<div id="atsPDF" class="pdf-container">
    <h1>Analyse ATS</h1>
    <div class="subtitle" id="atsSubtitle"></div>
    <div class="radar"><canvas id="atsRadar"></canvas></div>
    <div class="section badges">
        <h3>Open Badges</h3>
        <ul id="atsBadges"></ul>
    </div>
    <div class="section romes">
        <h3>Fiches ROME compatibles</h3>
        <ul id="atsRomes"></ul>
    </div>
    <div class="section missing" id="atsMissing" style="display:none;">
        <h3>Points manquants & Axes d'am√©lioration</h3>
        <ul id="atsPoints"></ul>
    </div>
    <div class="footer">RUNIC ‚Ä¢ Cr√©√© par C√©dric Odin</div>
</div>

<script>
    // === CONFIGURATION API - LIGNE 360 ===
    // üö® REMPLACEZ ICI VOTRE CLIENT SECRET (ligne 360) üö®
    const FT_CLIENT_ID = "PAR_runicats_4c5356704feaa3323073c02ba2bc8ab39976b234cdfdc3cd910a1a5698cd00c3";
    const FT_CLIENT_SECRET = "bc0994e1a9c66bc2cbfa0fd8be773159e8fc0566961b84d3d2e32991c69c1b99";
    let token = null;
    let cvData = null;
    let romeMatches = [];
    let badges = [];
    let pdfType = '';
    let jdTextValue = '';
    let currentChart = null;
    let radarChart = null;

    function showMessage(message, type = 'error') {
        const resultSection = document.getElementById('resultSection');
        resultSection.innerHTML = `<div class="${type}">${message}</div>`;
        resultSection.style.display = 'block';
        document.getElementById('loading').style.display = 'none';
    }

    function closeModal() {
        document.getElementById('infoModal').style.display = 'none';
    }

    // Parser CV (inchang√© - ultra-robuste)
    async function extractText(file) {
        try {
            const buffer = await file.arrayBuffer();
            const ext = file.name.split('.').pop().toLowerCase();
            let text = '';

            const rawText = new TextDecoder().decode(buffer).substring(0, 8000);
            if (ext === 'txt') return rawText;

            if (ext === 'pdf') {
                if (!window.pdfjsLib) return rawText;
                try {
                    const pdf = await pdfjsLib.getDocument({data: buffer}).promise;
                    for (let i = 1; i <= Math.min(pdf.numPages, 5); i++) {
                        const page = await pdf.getPage(i);
                        const content = await page.getTextContent();
                        const items = (content.items || []).map(item => ({
                            str: (item.str || '').trim(),
                            y: Math.round(item.transform?.[5] || 0)
                        })).filter(i => i.str.length > 0);

                        if (items.length === 0) return rawText;

                        items.sort((a, b) => b.y - a.y);
                        let line = '';
                        let lastY = null;
                        for (const item of items) {
                            if (lastY === null || Math.abs(item.y - lastY) > 12) {
                                if (line.trim()) text += line.trim() + '\n';
                                line = item.str;
                            } else line += ' ' + item.str;
                            lastY = item.y;
                        }
                        if (line.trim()) text += line.trim() + '\n\n';
                    }
                } catch (pdfError) {
                    return rawText;
                }
                return text.trim().substring(0, 8000);
            }

            if (ext === 'docx' && window.mammoth) {
                try {
                    const result = await mammoth.extractRawText({arrayBuffer: buffer});
                    return (result.value || rawText).trim().substring(0, 8000);
                } catch (docxError) {
                    return rawText;
                }
            }

            return rawText;
        } catch (error) {
            throw new Error('Impossible de lire ce fichier. Formats: PDF, DOCX, TXT');
        }
    }

    function parseCV(text) {
        const lines = text.split(/[\n\r]+/).map(l => l.trim()).filter(l => l.length > 1);
        const cv = {
            nom: 'Candidat',
            accroche: '',
            email: '',
            telephone: '',
            competences: [],
            experiences: [],
            formations: [],
            langues: []
        };

        // Recherche nom/pr√©nom
        const nomPatterns = [/^([A-Z√Ä√Å√Ç√É√Ñ√Ö√Ü√á√à√â√ä√ã√å√ç√é√è√ê√ë√í√ì√î√ï√ñ√ò√ô√ö√õ√ú√ù√û≈∏][a-z√†√°√¢√£√§√•√¶√ß√®√©√™√´√¨√≠√Æ√Ø√∞√±√≤√≥√¥√µ√∂√∏√π√∫√ª√º√Ω√æ√ø]+ [A-Z√Ä√Å√Ç√É√Ñ√Ö√Ü√á√à√â√ä√ã√å√ç√é√è√ê√ë√í√ì√î√ï√ñ√ò√ô√ö√õ√ú√ù√û≈∏][a-z√†√°√¢√£√§√•√¶√ß√®√©√™√´√¨√≠√Æ√Ø√∞√±√≤√≥√¥√µ√∂√∏√π√∫√ª√º√Ω√æ√ø]+)/i];
        for (let line of lines.slice(0, 10)) {
            for (let pattern of nomPatterns) {
                const match = line.match(pattern);
                if (match) {
                    cv.nom = match[1].trim().split(' ').slice(0,2).join(' ');
                    break;
                }
            }
            if (!cv.email && /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/.test(line)) {
                cv.email = line.match(/\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/)[0];
            }
        }

        cv.accroche = lines.find(l => l.length > 40 && l.length < 250) || 'Profil exp√©riment√© et motiv√©';

        let section = '';
        const patterns = {
            competences: [/comp√©tences?|skills?|techno(logie)?s?|savoir.?faire/i],
            experiences: [/exp√©rience|parcours|professionn(el|al)/i],
            formations: [/formation|√©tudi(e|es)|dipl√¥me|master|bac/i]
        };

        for (let line of lines) {
            const lower = line.toLowerCase();
            for (let [key, regexes] of Object.entries(patterns)) {
                if (regexes.some(regex => regex.test(line))) {
                    section = key;
                    break;
                }
            }
            if (section === 'competences' && (line.startsWith('‚Ä¢') || line.startsWith('-'))) {
                const comp = line.replace(/^[‚Ä¢\-\*\s]+/i, '').split(/[|,]/)[0].trim();
                if (comp.length > 2) cv.competences.push(comp);
            }
        }

        cv.competences = cv.competences.slice(0, 15);
        return cv;
    }

    // NOUVEAU: Recherche ROME TOUS DOMAINES + scoring ATS intelligent
    async function getRomeMatches(text) {
        const token = await getToken();
        
        // EXTRACTION MOTS-CLEFS DU CV POUR RECHERCHE LARGE
        const keywords = extractKeywords(text);
        console.log('üîç Mots-cl√©s extraits:', keywords.slice(0,10));

        if (!token) {
            // Fallback MULTI-DOMAINES r√©aliste bas√© sur mots-cl√©s
            return generateRomeMatchesFromKeywords(keywords);
        }

        try {
            // RECHERCHE LARGE: plusieurs requ√™tes par domaine/mot-cl√©
            const allMatches = [];
            const queries = [...keywords.slice(0,5), 'm√©tiers', 'emplois'].slice(0,3);
            
            for (const query of queries) {
                try {
                    const res = await fetch(`https://api.francetravail.io/partenaire/rome/v1/metiers/recherche?motCle=${encodeURIComponent(query)}`, {
                        headers: {Authorization: `Bearer ${token}`}
                    });
                    if (res.ok) {
                        const data = await res.json();
                        const metiers = data.resultats || data || [];
                        for (const m of metiers.slice(0,15)) {
                            const code = m.code || m.codeRome || m.id;
                            if (code) {
                                const detail = await getRomeDetail(code, token);
                                const score = calculateATSScore(text, detail, keywords);
                                if (score > 40) allMatches.push({code, libelle: detail.libelle || m.libelle, score});
                            }
                        }
                    }
                } catch (e) {
                    console.warn('Requ√™te ROME:', e);
                }
            }
            
            return allMatches.sort((a,b) => b.score - a.score).slice(0,8);
        } catch (error) {
            console.warn('ROME API √©chou√©e:', error);
            return generateRomeMatchesFromKeywords(keywords);
        }
    }

    // Extraction mots-cl√©s tous domaines
    function extractKeywords(text) {
        const lowerText = text.toLowerCase();
        const keywords = new Set();
        
        // Noms de postes tous domaines
        const jobTitles = [
            'd√©veloppeur', 'infirmier', 'professeur', 'comptable', 'cuisinier', '√©lectricien',
            'plombier', 'm√©canicien', 'avocat', 'm√©decin', 'enseignant', 'manager', 'vendeur',
            'magasinier', 'chauffeur', 'agent', 'technicien', 'ing√©nieur', 'commercial',
            'administratif', 'rh', 'marketing', 'communication', 'logistique', 'maintenance'
        ];
        
        jobTitles.forEach(title => {
            if (lowerText.includes(title)) keywords.add(title);
        });
        
        // Comp√©tences transversales
        const skills = ['gestion', 'management', 'relation client', 'commercial', 'technique', 'production'];
        skills.forEach(skill => {
            if (lowerText.includes(skill)) keywords.add(skill);
        });
        
        return Array.from(keywords);
    }

    // G√©n√©ration r√©sultats ROME multi-domaines r√©alistes
    function generateRomeMatchesFromKeywords(keywords) {
        const allRomeJobs = {
            informatique: [
                {code: 'M1805', libelle: 'D√©veloppeur web', score: 92},
                {code: 'M1803', libelle: 'D√©veloppeur Fullstack', score: 87}
            ],
            sante: [
                {code: 'N1105', libelle: 'Infirmier', score: 89},
                {code: 'N4105', libelle: 'Aide-soignant', score: 82}
            ],
            commerce: [
                {code: 'D1210', libelle: 'Conseiller client√®le', score: 88},
                {code: 'D1302', libelle: 'Vendeur conseil', score: 85}
            ],
            batiment: [
                {code: 'F1603', libelle: 'Electricien', score: 91},
                {code: 'F1405', libelle: 'Ma√ßon', score: 84}
            ],
            restauration: [
                {code: 'H3002', libelle: 'Cuisinier', score: 90},
                {code: 'H3102', libelle: 'Serveur', score: 83}
            ],
            education: [
                {code: 'K2111', libelle: 'Professeur des √©coles', score: 87},
                {code: 'K2123', libelle: 'Conseiller p√©dagogique', score: 80}
            ],
            compta: [
                {code: 'M1201', libelle: 'Comptable', score: 89},
                {code: 'M1205', libelle: 'Assistant comptable', score: 85}
            ]
        };

        const matches = [];
        Object.keys(allRomeJobs).forEach(domain => {
            allRomeJobs[domain].slice(0,2).forEach(job => {
                // Score bas√© sur mots-cl√©s du CV
                const keywordMatch = keywords.filter(kw => job.libelle.toLowerCase().includes(kw)).length;
                job.score = Math.max(65, job.score + keywordMatch * 10);
                matches.push(job);
            });
        });

        return matches.sort((a,b) => b.score - a.score).slice(0,8);
    }

    async function getToken() {
        if (token) return token;
        if (FT_CLIENT_SECRET === "VOTRE_CLIENT_SECRET_ICI") return null;

        try {
            const res = await fetch("https://entreprise.francetravail.fr/connexion/oauth2/access_token?realm=/partenaire", {
                method: "POST",
                headers: {"Content-Type": "application/x-www-form-urlencoded"},
                body: new URLSearchParams({
                    grant_type: "client_credentials",
                    client_id: FT_CLIENT_ID,
                    client_secret: FT_CLIENT_SECRET,
                    scope: "api_romev1"
                })
            });
            if (!res.ok) throw new Error(`Erreur ${res.status}`);
            const data = await res.json();
            token = data.access_token;
            return token;
        } catch (error) {
            return null;
        }
    }

    async function getRomeDetail(code, token) {
        try {
            const res = await fetch(`https://api.francetravail.io/partenaire/rome/v1/metier/${code}`, {
                headers: {Authorization: `Bearer ${token}`}
            });
            return await res.json();
        } catch (e) {
            return {libelle: code};
        }
    }

    function calculateATSScore(text, detail, keywords) {
        let score = 50;
        const lowerText = text.toLowerCase();
        const lowerLibelle = (detail.libelle || '').toLowerCase();
        
        if (lowerText.includes(lowerLibelle)) score += 30;
        keywords.forEach(kw => {
            if (lowerLibelle.includes(kw) || lowerText.includes(kw)) score += 8;
        });
        return Math.min(98, score);
    }

    // Radar SOFTSKILLS (calcul√© depuis CV)
    function createSoftSkillsRadar(containerId, canvasId) {
        if (radarChart) radarChart.destroy();
        
        const softSkills = {
            '√âcoute active': detectSkill('√©coute|attention|client', cvData),
            'Empathie': detectSkill('relation|humain|√©quipe', cvData),
            'R√©seaux': detectSkill('r√©seau|contact|partenaire', cvData),
            'Coop√©ration': detectSkill('√©quipe|coll√®gue|collaboration', cvData),
            'Adaptabilit√©': detectSkill('adapt|flexible|√©volu', cvData),
            'Organisation': detectSkill('organi|planifi|gestion', cvData),
            'Communication': detectSkill('communi|pr√©senta|parl√©', cvData),
            'R√©silience': detectSkill('stress|pression|d√©fi', cvData)
        };

        const canvas = document.getElementById(canvasId);
        const ctx = canvas.getContext('2d');
        canvas.width = 450;
        canvas.height = 450;

        radarChart = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: Object.keys(softSkills),
                datasets: [{
                    data: Object.values(softSkills),
                    backgroundColor: 'rgba(102,126,234,0.25)',
                    borderColor: 'rgba(102,126,234,0.9)',
                    borderWidth: 3,
                    pointBackgroundColor: 'white'
                }]
            },
            options: {
                responsive: false,
                scales: {
                    r: {
                        beginAtZero: true,
                        max: 10,
                        ticks: { stepSize: 2, color: '#666' },
                        grid: { color: 'rgba(0,0,0,0.1)' },
                        pointLabels: { font: { size: 12 } }
                    }
                },
                plugins: { legend: { display: false } }
            }
        });
    }

    function detectSkill(pattern, cv) {
        const text = (cv.accroche + ' ' + cv.competences.join(' ')).toLowerCase();
        const matches = (text.match(new RegExp(pattern, 'gi')) || []).length;
        return Math.min(9.8, 6 + matches * 0.8);
    }

    // Affichage r√©sultats ROME + radar AVANT PDF
    function displayResults() {
        let html = `
            <div class="radar-preview">
                <h3 style="text-align:center;color:var(--primary);margin-bottom:20px;">üìä Profil Softskills</h3>
                <canvas id="previewRadar"></canvas>
            </div>
            
            <div class="rome-results">
                <h3>üéØ Fiches ROME compatibles (Score ATS)</h3>
        `;

        romeMatches.forEach((match, i) => {
            html += `
                <div class="rome-item">
                    <div>
                        <strong>${match.libelle}</strong><br>
                        <small>${match.code}</small>
                    </div>
                    <div class="rome-score">${match.score}%</div>
                </div>
            `;
        });

        html += `
                ${romeMatches.length ? '' : '<p style="text-align:center;color:var(--gray-600);">Aucune correspondance trouv√©e</p>'}
            </div>

            <div class="action-buttons">
                <button class="btn" onclick="openPDFModal('passeport')">
                    <i class="fas fa-passport"></i> Le passeport de comp√©tence
                </button>
                <button class="btn" onclick="openPDFModal('ats')">
                    <i class="fas fa-robot"></i> Analyse ATS
                </button>
            </div>
        `;

        document.getElementById('resultSection').innerHTML = html;
        document.getElementById('resultSection').style.display = 'block';
        
        // Cr√©er radar softskills
        setTimeout(() => createSoftSkillsRadar('previewRadar', 'previewRadar'), 100);
    }

    // Fonctions PDF (inchang√©es)
    function collectBadges() {
        badges = [];
        document.querySelectorAll('.badge-item').forEach(item => {
            const inputs = item.querySelectorAll('input');
            if (inputs[0]?.value.trim()) {
                badges.push({
                    title: inputs[0].value.trim(),
                    issuer: inputs[1]?.value.trim() || ''
                });
            }
        });
    }

    function destroyChart(canvasId) {
        if (currentChart) {
            currentChart.destroy();
            currentChart = null;
        }
    }

    function createRadar(id) {
        destroyChart(id);
        const canvas = document.getElementById(id);
        canvas.width = 500;
        canvas.height = 500;
        
        const ctx = canvas.getContext('2d');
        currentChart = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: ['√âcoute active','Empathie','R√©seaux','Coop√©ration','Adaptabilit√©','Organisation','Communication','R√©silience'],
                datasets: [{
                    data: [9.5,9.5,9.6,9.2,9.0,9.3,8.8,9.0],
                    backgroundColor: 'rgba(102,126,234,0.35)',
                    borderColor: 'white',
                    borderWidth: 3
                }]
            },
            options: {
                responsive: false,
                scales: {
                    r: { beginAtZero: true, max: 10, ticks: { stepSize: 2, color: 'white' }, grid: { color: 'rgba(255,255,255,0.3)' }, pointLabels: { color: 'white', font: { size: 14 } } }
                },
                plugins: { legend: { display: false } }
            }
        });
    }

    async function generatePDF(elementId, filename) {
        try {
            const el = document.getElementById(elementId);
            el.style.display = 'block';
            await new Promise(resolve => setTimeout(resolve, 800));

            const canvas = await html2canvas(el, { scale: 2, useCORS: true, allowTaint: true });
            el.style.display = 'none';

            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const imgData = canvas.toDataURL('image/png');
            const imgWidth = 210;
            const pageHeight = 297;
            const imgHeight = (canvas.height * imgWidth) / canvas.width;
            let heightLeft = imgHeight;
            let position = 0;

            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;
            while (heightLeft > 0) {
                position = heightLeft - imgHeight;
                pdf.addPage();
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
            }

            pdf.save(filename);
            showMessage(`‚úÖ PDF "${filename}" g√©n√©r√© !`, 'success');
        } catch (error) {
            showMessage('‚ùå Erreur g√©n√©ration PDF', 'error');
        }
    }

    function openPDFModal(type) {
        if (!cvData) return showMessage('‚ö†Ô∏è Analysez d\'abord un CV', 'error');
        pdfType = type;
        document.getElementById('pdfName').value = cvData.nom || '';
        document.getElementById('pdfHook').value = cvData.accroche || '';
        collectBadges();
        document.getElementById('infoModal').style.display = 'flex';
    }

    function generateSelectedPDF() {
        const name = document.getElementById('pdfName').value || cvData.nom || 'Candidat';
        const hook = document.getElementById('pdfHook').value || cvData.accroche || '';
        document.getElementById('infoModal').style.display = 'none';
        collectBadges();

        if (pdfType === 'passeport') {
            document.getElementById('passeportSubtitle').textContent = `${name} ‚Äî ${hook}`;
            document.getElementById('passeportBadges').innerHTML = badges.length ? 
                badges.map(b => `<li>${b.title} - ${b.issuer}</li>`).join('') : 
                '<li>Aucun badge ‚Äì Ajoutez-en pour booster votre profil !</li>';
            document.getElementById('passeportMetiers').innerHTML = romeMatches.map(m => `<li>${m.libelle}</li>`).join('');
            createRadar('passeportRadar');
            generatePDF('passeportPDF', `Passeport_${name.replace(/\s+/g, '_')}.pdf`);
        } else {
            document.getElementById('atsSubtitle').textContent = `${name} ‚Äî ${hook}`;
            document.getElementById('atsBadges').innerHTML = document.getElementById('passeportBadges').innerHTML;
            document.getElementById('atsRomes').innerHTML = romeMatches.map(m => `<li>${m.libelle} (${m.score}%)</li>`).join('');
            if (jdTextValue.trim()) {
                document.getElementById('atsMissing').style.display = 'block';
                document.getElementById('atsPoints').innerHTML = '<li>üîç Aligner mots-cl√©s offre CV</li><li>‚ö° Ajouter comp√©tences techniques</li>';
            }
            createRadar('atsRadar');
            generatePDF('atsPDF', `Analyse_ATS_${name.replace(/\s+/g, '_')}.pdf`);
        }
    }

    function addBadge() {
        const div = document.createElement('div');
        div.className = 'badge-item';
        div.innerHTML = `
            <input type="text" placeholder="Titre du badge" maxlength="50">
            <input type="text" placeholder="√âmetteur" maxlength="40">
            <input type="text" placeholder="Date" maxlength="10">
            <input type="url" placeholder="Lien">
            <i class="fas fa-trash badge-remove" onclick="this.parentElement.remove()"></i>
        `;
        document.getElementById('badgesList').appendChild(div);
    }

    async function handleFile(file) {
        try {
            if (file.size > 15 * 1024 * 1024) throw new Error('Fichier trop volumineux (max 15MB)');

            document.getElementById('loading').style.display = 'block';
            document.getElementById('resultSection').innerHTML = '';
            document.getElementById('resultSection').style.display = 'none';

            jdTextValue = document.getElementById('jdText').value.trim();
            const text = await extractText(file);
            cvData = parseCV(text);
            romeMatches = await getRomeMatches(text);

            displayResults();
        } catch (error) {
            showMessage(error.message || 'Erreur traitement CV', 'error');
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) handleFile(file);
        });

        document.getElementById('infoModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });
    });
</script>
</body>
</html>
