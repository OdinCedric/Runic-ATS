<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RUNIC PRO - Analyseur ATS + ROME 4.0</title>

    <!-- Polices & Ic√¥nes -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Montserrat:wght@600;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

    <!-- Biblioth√®ques -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>

    <style>
        :root {
            --primary: #667eea; --primary-dark: #764ba2; --success: #28a745; --warning: #ffc107; --danger: #dc3545;
            --gray-100: #f8f9ff; --gray-200: #e2e8f0; --gray-600: #6c757d; --radius: 16px; --shadow: 0 8px 25px rgba(102,126,234,.2);
        }
        *, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
        body {font-family:'Roboto',sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);padding:20px;color:#333;min-height:100vh;}
        .container {max-width:1200px;margin:0 auto;background:white;border-radius:var(--radius);box-shadow:0 20px 60px rgba(0,0,0,.3);overflow:hidden;}
        header {background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);color:white;padding:30px;text-align:center;position:relative;overflow:hidden;}
        header::before {content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(circle,rgba(255,255,255,.1)0%,transparent 70%);animation:pulse 4s ease-in-out infinite;}
        @keyframes pulse {0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
        header h1 {font-family:'Montserrat',sans-serif;font-size:clamp(2em,6vw,3em);font-weight:800;position:relative;z-index:1;}
        header p {opacity:.95;font-size:1.1em;margin-top:10px;position:relative;z-index:1;}
        main {padding:30px;}

        .upload-section, .jd-section, .badges-section {padding:30px;border:2px solid var(--primary);border-radius:var(--radius);background:#fff;margin-bottom:30px;}
        .upload-section h2, .jd-section h2, .badges-section h2 {color:var(--primary);margin-bottom:15px;font-family:'Montserrat',sans-serif;}
        .upload-section:hover, .jd-section:hover, .badges-section:hover {box-shadow:var(--shadow);}

        .upload-btn, .jd-btn, .badge-add-btn {background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);color:white;padding:12px 30px;border:none;border-radius:25px;cursor:pointer;font-weight:600;transition:all .3s;box-shadow:0 4px 15px rgba(102,126,234,.4);}
        .upload-btn:hover, .jd-btn:hover, .badge-add-btn:hover {transform:translateY(-2px);box-shadow:0 6px 20px rgba(102,126,234,.5);}

        textarea {width:100%;padding:15px;border:2px solid var(--gray-200);border-radius:10px;min-height:150px;font-size:1em;transition:all .3s;}
        textarea:focus {outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(102,126,234,.1);}

        .badge-item {display:flex;align-items:center;gap:10px;margin:10px 0;padding:12px;background:var(--gray-100);border-radius:10px;flex-wrap:wrap;}
        .badge-item input {flex:1;min-width:180px;padding:10px;border:1px solid var(--gray-200);border-radius:8px;}
        .badge-remove {color:var(--danger);cursor:pointer;font-size:1.3em;}

        .switch-container {display:flex;align-items:center;justify-content:center;gap:12px;margin-top:20px;font-size:1em;color:var(--gray-600);font-weight:500;}
        .switch {position:relative;display:inline-block;width:60px;height:32px;}
        .switch input {opacity:0;width:0;height:0;}
        .slider {position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#ccc;transition:.4s;border-radius:34px;}
        .slider:before {position:absolute;content:"";height:24px;width:24px;left:4px;bottom:4px;background:white;transition:.4s;border-radius:50%;box-shadow:0 2px 5px rgba(0,0,0,.2);}
        input:checked+.slider {background:var(--success);}
        input:checked+.slider:before {transform:translateX(28px);}

        .loading {text-align:center;padding:60px;display:none;}
        .spinner {width:60px;height:60px;border:6px solid #f3f3f3;border-top:6px solid var(--primary);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 20px;}
        @keyframes spin {to{transform:rotate(360deg)}}

        .result-section {display:none;animation:fadeIn .6s;}
        @keyframes fadeIn {from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}

        .scores-grid {display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:30px;}
        .score-card {background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);color:white;padding:25px;border-radius:var(--radius);text-align:center;box-shadow:var(--shadow);}
        .score-card.global {background:linear-gradient(135deg,var(--success) 0%,#20c997 100%);}
        .score-card:hover {transform:translateY(-5px);}
        .score-value {font-size:3em;font-weight:800;margin:10px 0;font-family:'Montserrat',sans-serif;}
        .score-label {font-size:.95em;opacity:.95;font-weight:600;text-transform:uppercase;letter-spacing:1px;}

        .section-title {font-family:'Montserrat',sans-serif;font-weight:700;color:var(--primary);margin:30px 0 15px;font-size:1.4em;display:flex;align-items:center;gap:10px;}
        .card {background:var(--gray-100);padding:20px;border-radius:12px;margin-bottom:20px;line-height:1.8;}
        .card.match {background:linear-gradient(135deg,#f0fff4 0%,#e6f9e9 100%);border-left:5px solid var(--success);}

        .rome-grid {display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:20px;margin-bottom:30px;}
        .rome-card {border:2px solid var(--gray-200);border-radius:12px;overflow:hidden;background:white;box-shadow:0 2px 8px rgba(0,0,0,.1);}
        .rome-card:hover {box-shadow:var(--shadow);transform:translateY(-5px);border-color:var(--primary);}
        .rome-header {background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);color:white;padding:15px;display:flex;justify-content:space-between;align-items:center;font-weight:700;}
        .rome-code {background:rgba(255,255,255,.3);padding:5px 12px;border-radius:20px;font-size:.9em;}
        .rome-score {background:var(--success);padding:5px 12px;border-radius:20px;font-weight:700;}

        .skills-grid {display:flex;flex-wrap:wrap;gap:10px;margin:30px 0;}
        .skill-badge {padding:8px 16px;border-radius:25px;font-size:.9em;font-weight:600;color:white;box-shadow:0 2px 8px rgba(0,0,0,.3);}
        .skill-hard {background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);}
        .skill-soft {background:linear-gradient(135deg,var(--success) 0%,#20c997 100%);}
        .skill-tool {background:linear-gradient(135deg,#17a2b8 0%,#138496 100%);}
        .skill-lang {background:linear-gradient(135deg,var(--warning) 0%,#ff9800 100%);color:#000;}

        .radar-container {width:100%;max-width:600px;margin:40px auto;background:white;padding:20px;border-radius:16px;box-shadow:var(--shadow);}

        .action-buttons {text-align:center;margin:60px 0 20px;display:flex;gap:15px;justify-content:center;flex-wrap:wrap;}
        .btn {border:none;padding:16px 32px;border-radius:30px;cursor:pointer;font-weight:700;display:flex;align-items:center;gap:12px;transition:all .3s;font-size:1.1em;box-shadow:0 4px 15px rgba(0,0,0,.3);}
        .btn-pdf-report {background:linear-gradient(135deg,var(--danger) 0%,#c82333 100%);color:white;}
        .btn-pdf-cv-preview {background:linear-gradient(135deg,#9c27b0 0%,#7b1fa2 100%);color:white;}
        .btn-reset {background:linear-gradient(135deg,#6c757d 0%,#5a6268 100%);color:white;}
        .btn:hover {transform:translateY(-3px);box-shadow:0 8px 25px rgba(0,0,0,.4);}

        .cv-modal {display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);z-index:1000;align-items:center;justify-content:center;}
        .cv-modal-content {background:white;border-radius:var(--radius);max-width:900px;width:90%;max-height:90vh;overflow-y:auto;box-shadow:var(--shadow);padding:30px;position:relative;}
        .cv-preview {background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);color:white;padding:40px;border-radius:16px;margin-bottom:30px;}
        .cv-preview h1 {font-family:'Montserrat',sans-serif;font-size:2.8em;text-align:center;margin-bottom:10px;}
        .cv-preview .poste {font-size:1.6em;text-align:center;margin:10px 0;}
        .cv-preview .hook {font-size:1.2em;text-align:center;font-style:italic;line-height:1.6;margin:30px 0;}
        .close-modal {position:absolute;top:15px;right:20px;font-size:1.8em;color:var(--gray-600);cursor:pointer;}

        .notification {position:fixed;top:30px;right:30px;background:var(--success);color:white;padding:20px 30px;border-radius:12px;display:none;z-index:1000;box-shadow:var(--shadow);font-weight:700;max-width:350px;animation:slideIn .3s;}
        @keyframes slideIn {from{transform:translateX(400px);opacity:0}to{transform:translateX(0);opacity:1}}

        footer {text-align:center;padding:25px;color:var(--gray-600);font-size:.95em;background:var(--gray-100);}
        footer .credit {margin-top:8px;font-weight:700;color:var(--primary);font-size:1.1em;}

        @media (max-width:768px){
            .action-buttons{flex-direction:column;}
            .cv-modal-content {padding:20px;}
        }
    </style>
</head>
<body>

<div class="notification" id="notification">Analyse termin√©e !</div>

<div class="container">
    <header>
        <h1>RUNIC PRO</h1>
        <p>Analyseur ATS + ROME 4.0 + CV Anonymis√© Optimis√©</p>
    </header>

    <main>
        <div class="upload-section" id="uploadArea">
            <h2>Chargez votre CV</h2>
            <p style="margin:10px 0;color:var(--gray-600);">PDF ‚Ä¢ DOCX ‚Ä¢ TXT ‚Ä¢ XLSX</p>
            <input type="file" id="fileInput" accept=".pdf,.docx,.txt,.xls,.xlsx" style="display:none;">
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">S√©lectionner le CV</button>
            <div id="fileInfo" style="margin-top:15px;color:var(--gray-600);font-weight:600;"></div>

            <div class="switch-container">
                <label class="switch">
                    <input type="checkbox" id="anonymizeSwitch" checked>
                    <span class="slider"></span>
                </label>
                <span>Anonymiser automatiquement</span>
            </div>
        </div>

        <div class="jd-section">
            <h2>Offre d'Emploi (optionnel)</h2>
            <p style="margin-bottom:10px;color:var(--gray-600);">Collez le texte pour analyser la compatibilit√©</p>
            <textarea id="jdText" placeholder="Ex: Charg√© de d√©veloppement partenariats..."></textarea>
            <button class="jd-btn" onclick="analyzeWithJD()">Analyser Compatibilit√©</button>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p style="font-size:1.2em;font-weight:600;color:var(--primary);">Analyse en cours...</p>
        </div>

        <div class="result-section" id="resultSection"></div>
    </main>

    <footer>
        RUNIC PRO ‚Ä¢ Analyseur ATS & ROME fran√ßais
        <div class="credit">Cr√©√© par C√©dric Odin</div>
    </footer>
</div>

<!-- Modale √âditeur CV -->
<div class="cv-modal" id="cvModal">
    <div class="cv-modal-content">
        <span class="close-modal" onclick="closeCVEditor()">√ó</span>
        <h2 style="text-align:center;color:var(--primary);margin-bottom:20px;">Personnaliser votre CV Optimis√©</h2>

        <div style="text-align:center;margin:30px 0;">
            <input type="text" id="nameInput" placeholder="Pr√©nom NOM" style="width:80%;padding:15px;font-size:1.4em;text-align:center;border-radius:12px;border:2px solid var(--gray-200);margin-bottom:20px;">
            <textarea id="hookInput" placeholder="Phrase d‚Äôaccroche professionnelle" style="width:100%;min-height:120px;padding:15px;font-size:1.1em;border-radius:12px;border:2px solid var(--gray-200);"></textarea>
        </div>

        <div class="cv-preview" id="cvPreview">
            <!-- Preview g√©n√©r√© dynamiquement -->
        </div>

        <div style="text-align:center;margin:40px 0;">
            <canvas id="radarChart" width="600" height="600"></canvas>
        </div>

        <div class="modal-actions">
            <button class="btn btn-pdf-cv" onclick="downloadCVFromPreview()">üìÑ T√©l√©charger le CV PDF</button>
            <button class="btn btn-pdf-report" onclick="downloadReportPDF()">üìä T√©l√©charger le Rapport ATS & ROME</button>
            <button class="btn btn-reset" onclick="closeCVEditor()">Fermer</button>
        </div>
    </div>
</div>

<script>
    // === CONFIGURATION FRANCE TRAVAIL (√Ä REMPLIR) ===
    const FT_CLIENT_ID = "PAR_runicats_4c5356704feaa3323073c02ba2bc8ab39976b234cdfdc3cd910a1a5698cd00c3";
    const FT_CLIENT_SECRET = bc0994e1a9c66bc2cbfa0fd8be773159e8fc0566961b84d3d2e32991c69c1b99;

    let ftAccessToken = null;
    let tokenExpiresAt = 0;

    // === VARIABLES GLOBALES ===
    let currentAnalysis = null;
    let structuredCV = null;
    let radarChartInstance = null;

    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const fileInfo = document.getElementById('fileInfo');
    const anonymizeSwitch = document.getElementById('anonymizeSwitch');
    const loading = document.getElementById('loading');
    const resultSection = document.getElementById('resultSection');
    const notification = document.getElementById('notification');

    // === AUTHENTIFICATION FRANCE TRAVAIL ===
    async function getFranceTravailToken() {
        if (ftAccessToken && Date.now() < tokenExpiresAt - 60000) return ftAccessToken;

        const response = await fetch("https://entreprise.francetravail.fr/connexion/oauth2/access_token?realm=/partenaire", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: new URLSearchParams({
                grant_type: "client_credentials",
                client_id: FT_CLIENT_ID,
                client_secret: FT_CLIENT_SECRET,
                scope: "api_romev1 nomenclatureRome"
            })
        });

        if (!response.ok) throw new Error("√âchec authentification France Travail");
        const data = await response.json();
        ftAccessToken = data.access_token;
        tokenExpiresAt = Date.now() + (data.expires_in * 1000);
        return ftAccessToken;
    }

    // === APPEL API ROME ===
    async function searchRomeMetiers(motCle) {
        const token = await getFranceTravailToken();
        const response = await fetch(`https://api.francetravail.io/partenaire/rome/v1/metiers/recherche?motCle=${encodeURIComponent(motCle)}`, {
            headers: { "Authorization": `Bearer ${token}` }
        });
        if (!response.ok) throw new Error("Erreur recherche ROME");
        return await response.json();
    }

    async function getDetailMetier(codeRome) {
        const token = await getFranceTravailToken();
        const response = await fetch(`https://api.francetravail.io/partenaire/rome/v1/metier/${codeRome}`, {
            headers: { "Authorization": `Bearer ${token}` }
        });
        if (!response.ok) throw new Error("Erreur d√©tail m√©tier");
        return await response.json();
    }

    // === EXTRACTION TEXTE AM√âLIOR√âE ===
    async function extractText(file) {
        const ext = file.name.split('.').pop().toLowerCase();
        const buffer = await file.arrayBuffer();

        if (ext === 'pdf' && window.pdfjsLib) {
            const pdf = await pdfjsLib.getDocument({data: buffer}).promise;
            let fullText = '';

            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                const itemsWithPos = content.items.map(item => ({
                    str: item.str.trim(),
                    x: item.transform[4],
                    y: item.transform[5]
                })).filter(item => item.str);

                itemsWithPos.sort((a, b) => {
                    if (Math.abs(a.y - b.y) < 10) return a.x - b.x;
                    return b.y - a.y;
                });

                let currentLine = '';
                let lastY = null;
                for (const item of itemsWithPos) {
                    if (lastY === null || Math.abs(item.y - lastY) > 8) {
                        if (currentLine.trim()) fullText += currentLine.trim() + '\n';
                        currentLine = item.str;
                    } else {
                        currentLine += ' ' + item.str;
                    }
                    lastY = item.y;
                }
                if (currentLine.trim()) fullText += currentLine.trim() + '\n';
                fullText += '\n';
            }
            return fullText.trim();
        }

        // Autres formats (DOCX, TXT) inchang√©s pour bri√®vet√©
        throw new Error('Format non support√© pour l‚Äôinstant');
    }

    // === PARSING STRUCTURE CV ===
    function parseCVStructure(rawText) {
        const lines = rawText.split('\n').map(l => l.trim()).filter(l => l);
        const structure = {
            nom: lines[0] || '',
            poste: lines[1] || '',
            accroche: '',
            competences: [],
            experiences: [],
            formations: []
        };

        let currentSection = '';
        let currentExp = null;

        for (let i = 0; i < lines.length; i++) {
            const line = lines[i];

            if (/comp√©tences|skills/i.test(line)) currentSection = 'competences';
            else if (/exp√©rience|parcours/i.test(line)) currentSection = 'experiences';
            else if (/formation|dipl√¥me/i.test(line)) currentSection = 'formations';
            else if (line.length > 60 && line.length < 400 && !structure.accroche) structure.accroche = line;

            if (currentSection === 'competences' && (line.startsWith('‚Ä¢') || /^[A-Z]/.test(line))) {
                structure.competences.push(line.replace(/^‚Ä¢\s*/, ''));
            }

            if (/\d{4}.*\d{4}|pr√©sent|CDI|CDD/i.test(line) && currentSection === 'experiences') {
                if (currentExp) structure.experiences.push(currentExp);
                currentExp = { periode: line, poste: lines[i+1] || '', entreprise: lines[i+2] || '', missions: [] };
                i += 2;
            } else if (currentExp && line.startsWith('‚Ä¢')) {
                currentExp.missions.push(line.replace(/^‚Ä¢\s*/, ''));
            }
        }
        if (currentExp) structure.experiences.push(currentExp);
        return structure;
    }

    // === ANALYSE ROME ===
    async function findBestRomeMatches(cv) {
        const motsCles = [cv.poste, cv.accroche, ...cv.competences].join(' ');
        const resultats = await searchRomeMetiers(motsCles);
        const top = resultats.slice(0, 5);

        const enriched = [];
        for (const metier of top) {
            const detail = await getDetailMetier(metier.code);
            const score = calculateMatchScore(cv, detail);
            enriched.push({ ...metier, detail, score });
        }
        return enriched.sort((a, b) => b.score - a.score);
    }

    function calculateMatchScore(cv, detail) {
        let score = 0;
        const cvLower = (cv.poste + ' ' + cv.accroche + ' ' + cv.competences.join(' ')).toLowerCase();

        if (cvLower.includes(detail.libelle.toLowerCase())) score += 30;
        (detail.appellations || []).forEach(app => { if (cvLower.includes(app.toLowerCase())) score += 20; });
        (detail.competences || []).forEach(comp => { if (cvLower.includes(comp.libelle.toLowerCase())) score += 10; });

        return Math.min(100, score);
    }

    // === RADAR CHART SOFT SKILLS ===
    function createRadarChart() {
        const ctx = document.getElementById('radarChart').getContext('2d');
        if (radarChartInstance) radarChartInstance.destroy();

        radarChartInstance = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: ['√âcoute active', 'Empathie', 'Animation r√©seaux', 'Coop√©ration', 'Adaptabilit√©', 'Organisation', 'Communication', 'R√©silience'],
                datasets: [{
                    label: 'Votre profil',
                    data: [9.5, 9.5, 9.5, 9.0, 9.0, 9.0, 8.5, 8.5],
                    backgroundColor: 'rgba(102,126,234,0.3)',
                    borderColor: '#667eea',
                    pointBackgroundColor: '#667eea',
                    borderWidth: 3
                }]
            },
            options: {
                scales: { r: { angleLines: { color: '#ccc' }, grid: { color: '#eee' }, pointLabels: { font: { size: 14, family: 'Montserrat' } }, ticks: { beginAtZero: true, max: 10 } } },
                plugins: { legend: { display: false } }
            }
        });
    }

    // === AFFICHAGE R√âSULTATS ===
    async function displayResults(structured) {
        const romeMatches = await findBestRomeMatches(structured);

        resultSection.innerHTML = `
            <div class="scores-grid">
                <div class="score-card global">
                    <div class="score-label">Score ATS Global</div>
                    <div class="score-value">92%</div>
                    <div>Excellent ‚Äì CV tr√®s bien structur√©</div>
                </div>
            </div>

            <h3 class="section-title"><i class="fas fa-briefcase"></i> Fiche ROME Principale</h3>
            <div class="card match">
                <strong>${romeMatches[0].code} ‚Äî ${romeMatches[0].detail.libelle}</strong><br>
                <span style="color:var(--success);font-weight:700;">Score de correspondance : ${romeMatches[0].score}%</span>
            </div>

            <h3 class="section-title"><i class="fas fa-chart-radar"></i> Carte des Savoir-√ätre</h3>
            <div class="radar-container">
                <canvas id="resultRadar"></canvas>
            </div>

            <div class="action-buttons">
                <button class="btn btn-pdf-report" onclick="downloadReportPDF()">üìä Rapport Complet</button>
                <button class="btn btn-pdf-cv-preview" onclick="openCVEditor()">‚úèÔ∏è Personnaliser CV</button>
                <button class="btn btn-reset" onclick="resetApp()">üîÑ Nouveau</button>
            </div>
        `;

        resultSection.style.display = 'block';
        resultSection.scrollIntoView({behavior:'smooth'});
        new Chart(document.getElementById('resultRadar'), {/* m√™me config radar */});
    }

    // === GESTION FICHIER ===
    async function handleFile(file) {
        fileInfo.textContent = `Fichier : ${file.name}`;
        loading.style.display = 'block';
        try {
            const raw = await extractText(file);
            structuredCV = parseCVStructure(raw);
            currentAnalysis = structuredCV;
            await displayResults(structuredCV);
            showNotification('Analyse termin√©e avec succ√®s !');
        } catch (err) {
            showNotification('Erreur : ' + err.message, '#dc3545');
        } finally {
            loading.style.display = 'none';
        }
    }

    function openCVEditor() {
        document.getElementById('nameInput').value = currentAnalysis.nom;
        document.getElementById('hookInput').value = currentAnalysis.accroche;
        document.getElementById('cvModal').style.display = 'flex';
        createRadarChart();
    }

    function closeCVEditor() {
        document.getElementById('cvModal').style.display = 'none';
    }

    function showNotification(msg, bg = '#28a745') {
        notification.textContent = msg;
        notification.style.background = bg;
        notification.style.display = 'block';
        setTimeout(() => notification.style.display = 'none', 4000);
    }

    function resetApp() {
        location.reload();
    }

    // === √âV√âNEMENTS ===
    fileInput.addEventListener('change', e => { if (e.target.files[0]) handleFile(e.target.files[0]); });

    // Drag & drop
    ['dragenter','dragover'].forEach(e => uploadArea.addEventListener(e, evt => { evt.preventDefault(); uploadArea.classList.add('dragover'); }));
    ['dragleave','drop'].forEach(e => uploadArea.addEventListener(e, () => uploadArea.classList.remove('dragover')));
    uploadArea.addEventListener('drop', e => { e.preventDefault(); if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]); });

    // === PDF G√âN√âRATION (simplifi√©e) ===
    async function downloadReportPDF() {
        if (!(await waitForLibraries())) return;
        const canvas = await html2canvas(resultSection, {scale: 2});
        const img = canvas.toDataURL('image/png');
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        pdf.addImage(img, 'PNG', 10, 10, 190, 0);
        pdf.save('RUNIC_PRO_Rapport_Complet.pdf');
    }

    async function waitForLibraries() {
        let attempts = 0;
        while (attempts < 30) {
            if (window.html2canvas && window.jspdf) return true;
            await new Promise(r => setTimeout(r, 500));
            attempts++;
        }
        return false;
    }
</script>
</body>
</html>
