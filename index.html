<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RUNIC PRO - Analyseur ATS + ROME 4.0</title>

    <!-- Polices & Ic√¥nes -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Montserrat:wght@600;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

    <!-- Biblioth√®ques -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>

    <style>
        :root {
            --primary: #667eea; --primary-dark: #764ba2; --success: #28a745; --warning: #ffc107; --danger: #dc3545;
            --gray-100: #f8f9ff; --gray-200: #e2e8f0; --gray-600: #6c757d; --radius: 16px; --shadow: 0 8px 25px rgba(102,126,234,.2);
        }
        *, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
        body {font-family:'Roboto',sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);padding:20px;color:#333;min-height:100vh;}
        .container {max-width:1200px;margin:0 auto;background:white;border-radius:var(--radius);box-shadow:0 20px 60px rgba(0,0,0,.3);overflow:hidden;}
        header {background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);color:white;padding:30px;text-align:center;position:relative;overflow:hidden;}
        header::before {content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(circle,rgba(255,255,255,.1)0%,transparent 70%);animation:pulse 4s ease-in-out infinite;}
        @keyframes pulse {0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
        header h1 {font-family:'Montserrat',sans-serif;font-size:clamp(2em,6vw,3em);font-weight:800;position:relative;z-index:1;}
        header p {opacity:.95;font-size:1.1em;margin-top:10px;position:relative;z-index:1;}
        main {padding:30px;}

        .upload-section, .jd-section, .badges-section {padding:30px;border:2px solid var(--primary);border-radius:var(--radius);background:#fff;margin-bottom:30px;}
        .upload-section h2, .jd-section h2, .badges-section h2 {color:var(--primary);margin-bottom:15px;font-family:'Montserrat',sans-serif;}
        .upload-section:hover, .jd-section:hover, .badges-section:hover {box-shadow:var(--shadow);}

        .upload-btn, .jd-btn, .badge-add-btn {background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);color:white;padding:12px 30px;border:none;border-radius:25px;cursor:pointer;font-weight:600;transition:all .3s;box-shadow:0 4px 15px rgba(102,126,234,.4);}
        .upload-btn:hover, .jd-btn:hover, .badge-add-btn:hover {transform:translateY(-2px);box-shadow:0 6px 20px rgba(102,126,234,.5);}

        textarea {width:100%;padding:15px;border:2px solid var(--gray-200);border-radius:10px;min-height:150px;font-size:1em;transition:all .3s;}
        textarea:focus {outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(102,126,234,.1);}

        .badge-item {display:flex;align-items:center;gap:10px;margin:10px 0;padding:12px;background:var(--gray-100);border-radius:10px;flex-wrap:wrap;}
        .badge-item input {flex:1;min-width:180px;padding:10px;border:1px solid var(--gray-200);border-radius:8px;}
        .badge-remove {color:var(--danger);cursor:pointer;font-size:1.3em;}

        .switch-container {display:flex;align-items:center;justify-content:center;gap:12px;margin-top:20px;font-size:1em;color:var(--gray-600);font-weight:500;}
        .switch {position:relative;display:inline-block;width:60px;height:32px;}
        .switch input {opacity:0;width:0;height:0;}
        .slider {position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#ccc;transition:.4s;border-radius:34px;}
        .slider:before {position:absolute;content:"";height:24px;width:24px;left:4px;bottom:4px;background:white;transition:.4s;border-radius:50%;box-shadow:0 2px 5px rgba(0,0,0,.2);}
        input:checked+.slider {background:var(--success);}
        input:checked+.slider:before {transform:translateX(28px);}

        .loading {text-align:center;padding:60px;display:none;}
        .spinner {width:60px;height:60px;border:6px solid #f3f3f3;border-top:6px solid var(--primary);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 20px;}
        @keyframes spin {to{transform:rotate(360deg)}}

        .result-section {display:none;animation:fadeIn .6s;}
        @keyframes fadeIn {from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}

        .scores-grid {display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:30px;}
        .score-card {background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);color:white;padding:25px;border-radius:var(--radius);text-align:center;box-shadow:var(--shadow);}
        .score-card.global {background:linear-gradient(135deg,var(--success) 0%,#20c997 100%);}
        .score-card:hover {transform:translateY(-5px);box-shadow:0 12px 35px rgba(102,126,234,.4);}
        .score-value {font-size:3em;font-weight:800;margin:10px 0;font-family:'Montserrat',sans-serif;}
        .score-label {font-size:.95em;opacity:.95;font-weight:600;text-transform:uppercase;letter-spacing:1px;}

        .detailed-scores {display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:30px;}
        .detail-card {background:var(--gray-100);padding:20px;border-radius:12px;border-left:4px solid var(--primary);}
        .detail-score {font-size:2em;font-weight:700;color:var(--primary);}
        .detail-label {font-size:.9em;color:var(--gray-600);font-weight:600;}

        .section-title {font-family:'Montserrat',sans-serif;font-weight:700;color:var(--primary);margin:30px 0 15px;font-size:1.4em;display:flex;align-items:center;gap:10px;}
        .card {background:var(--gray-100);padding:20px;border-radius:12px;margin-bottom:20px;border-left:5px solid var(--primary);line-height:1.8;}
        .card.match {background:linear-gradient(135deg,#f0fff4 0%,#e6f9e9 100%);border-left-color:var(--success);}

        .rome-grid {display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:20px;margin-bottom:30px;}
        .rome-card {border:2px solid var(--gray-200);border-radius:12px;overflow:hidden;background:white;box-shadow:0 2px 8px rgba(0,0,0,.1);}
        .rome-card:hover {box-shadow:var(--shadow);transform:translateY(-5px);border-color:var(--primary);}
        .rome-header {background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);color:white;padding:15px;display:flex;justify-content:space-between;align-items:center;font-weight:700;}
        .rome-code {background:rgba(255,255,255,.3);padding:5px 12px;border-radius:20px;font-size:.9em;}
        .rome-score {background:var(--success);padding:5px 12px;border-radius:20px;font-weight:700;}

        .skills-grid {display:flex;flex-wrap:wrap;gap:10px;margin-bottom:30px;}
        .skill-badge {background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);color:white;padding:8px 16px;border-radius:25px;font-size:.9em;font-weight:600;box-shadow:0 2px 8px rgba(102,126,234,.3);}
        .skill-tech {background:linear-gradient(135deg,#17a2b8 0%,#138496 100%);}
        .skill-soft {background:linear-gradient(135deg,var(--success) 0%,#20c997 100%);}
        .skill-lang {background:linear-gradient(135deg,var(--warning) 0%,#ff9800 100%);color:#000;}

        .action-buttons {text-align:center;margin:60px 0 20px;display:flex;gap:15px;justify-content:center;flex-wrap:wrap;}
        .btn {border:none;padding:16px 32px;border-radius:30px;cursor:pointer;font-weight:700;display:flex;align-items:center;gap:12px;transition:all .3s;font-size:1.1em;box-shadow:0 4px 15px rgba(0,0,0,.3);}
        .btn-pdf-report {background:linear-gradient(135deg,var(--danger) 0%,#c82333 100%);color:white;}
        .btn-pdf-cv-preview {background:linear-gradient(135deg,#9c27b0 0%,#7b1fa2 100%);color:white;}
        .btn-reset {background:linear-gradient(135deg,#6c757d 0%,#5a6268 100%);color:white;}
        .btn:hover {transform:translateY(-3px);box-shadow:0 8px 25px rgba(0,0,0,.4);}

        .cv-modal {display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);z-index:1000;align-items:center;justify-content:center;}
        .cv-modal-content {background:white;border-radius:var(--radius);max-width:900px;width:90%;max-height:90vh;overflow-y:auto;box-shadow:var(--shadow);padding:30px;position:relative;}
        .cv-preview {background:#f8f9ff;padding:40px;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.1);margin-bottom:30px;}
        .cv-preview h1 {font-family:'Montserrat',sans-serif;font-size:2.8em;color:var(--primary);text-align:center;margin-bottom:10px;}
        .cv-preview h2 {font-family:'Montserrat',sans-serif;font-size:1.8em;color:var(--primary-dark);text-align:center;margin:20px 0 15px;}
        .cv-preview .hook {font-size:1.2em;text-align:center;color:#333;margin:20px 0;font-style:italic;line-height:1.6;}
        .cv-preview .skills-grid {display:flex;flex-wrap:wrap;gap:12px;justify-content:center;margin:20px 0;}
        .cv-preview .skill-badge {padding:10px 20px;border-radius:30px;font-weight:600;color:white;box-shadow:0 4px 15px rgba(0,0,0,.2);}
        .cv-preview .skill-tech {background:linear-gradient(135deg,#17a2b8 0%,#138496 100%);}
        .cv-preview .skill-soft {background:linear-gradient(135deg,var(--success) 0%,#20c997 100%);}
        .cv-preview .skill-lang {background:linear-gradient(135deg,var(--warning) 0%,#ff9800 100%);color:#000;}
        .cv-preview .badges-list {margin-top:30px;}
        .cv-preview .badge-entry {margin:15px 0;padding:15px;background:var(--gray-100);border-radius:12px;}
        .cv-preview .badge-entry strong {color:var(--primary);}

        .modal-actions {text-align:center;margin-top:30px;display:flex;gap:15px;justify-content:center;}
        .close-modal {position:absolute;top:15px;right:20px;font-size:1.8em;color:var(--gray-600);cursor:pointer;}

        .notification {position:fixed;top:30px;right:30px;background:var(--success);color:white;padding:20px 30px;border-radius:12px;display:none;z-index:1000;box-shadow:var(--shadow);font-weight:700;max-width:350px;animation:slideIn .3s;}
        @keyframes slideIn {from{transform:translateX(400px);opacity:0}to{transform:translateX(0);opacity:1}}

        footer {text-align:center;padding:25px;color:var(--gray-600);font-size:.95em;background:var(--gray-100);border-top:2px solid var(--gray-200);}
        footer .credit {margin-top:8px;font-weight:700;color:var(--primary);font-size:1.1em;}

        @media (max-width:768px){
            .action-buttons{flex-direction:column;}
            .cv-modal-content {padding:20px;}
            .badge-item {flex-direction:column;align-items:flex-start;}
        }
    </style>
</head>
<body>

<div class="notification" id="notification">Analyse termin√©e !</div>

<div class="container">
    <header>
        <h1>RUNIC PRO</h1>
        <p>Analyseur ATS + ROME 4.0 + CV Anonymis√© Optimis√©</p>
    </header>

    <main>
        <div class="upload-section" id="uploadArea">
            <h2>Chargez votre CV</h2>
            <p style="margin:10px 0;color:var(--gray-600);">PDF ‚Ä¢ DOCX ‚Ä¢ TXT ‚Ä¢ XLSX</p>
            <input type="file" id="fileInput" accept=".pdf,.docx,.txt,.xls,.xlsx" style="display:none;">
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">S√©lectionner le CV</button>
            <div id="fileInfo" style="margin-top:15px;color:var(--gray-600);font-weight:600;"></div>

            <div class="switch-container">
                <label class="switch">
                    <input type="checkbox" id="anonymizeSwitch" checked>
                    <span class="slider"></span>
                </label>
                <span>Anonymiser automatiquement</span>
            </div>
        </div>

        <div class="jd-section">
            <h2>Offre d'Emploi (optionnel)</h2>
            <p style="margin-bottom:10px;color:var(--gray-600);">Collez le texte pour analyser la compatibilit√©</p>
            <textarea id="jdText" placeholder="Ex: D√©veloppeur Full-Stack React/Node.js..."></textarea>
            <button class="jd-btn" onclick="analyzeWithJD()">Analyser Compatibilit√©</button>
        </div>

        <div class="badges-section">
            <h2>üèÖ Open Badges Obtenus (optionnel)</h2>
            <p style="margin-bottom:15px;color:var(--gray-600);">Ajoutez vos badges num√©riques v√©rifiables</p>
            <button class="badge-add-btn" onclick="addBadge()">+ Ajouter un badge</button>
            <div id="badgesList" style="margin-top:20px;"></div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p style="font-size:1.2em;font-weight:600;color:var(--primary);">Analyse en cours...</p>
        </div>

        <div class="result-section" id="resultSection">
            <!-- Tout le contenu sera inject√© par JS -->
        </div>
    </main>

    <footer>
        RUNIC PRO ‚Ä¢ Analyseur ATS & G√©n√©rateur de CV Anonymis√©
        <div class="credit">Cr√©√© par C√©dric Odin</div>
    </footer>
</div>

<!-- Modale √âditeur CV -->
<div class="cv-modal" id="cvModal">
    <div class="cv-modal-content">
        <span class="close-modal" onclick="closeCVEditor()">√ó</span>
        <h2 style="text-align:center;color:var(--primary);margin-bottom:20px;">Personnaliser votre CV Anonymis√© Optimis√©</h2>
        <div style="text-align:center;margin:20px 0;">
            <textarea id="hookInput" placeholder="Phrase d‚Äôaccroche (modifiable)" style="width:100%;min-height:100px;padding:15px;font-size:1.1em;border-radius:12px;border:2px solid var(--gray-200);"></textarea>
        </div>
        <div class="cv-preview" id="cvPreview"></div>
        <div class="modal-actions">
            <button class="btn btn-pdf-cv" onclick="downloadCVFromPreview()">üìÑ T√©l√©charger le PDF</button>
            <button class="btn btn-reset" onclick="closeCVEditor()">Fermer</button>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        if (window.pdfjsLib) {
            window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }
    });

    const romeDatabase = [
        {code:"M1805",libelle:"D√©veloppeur informatique",domaine:"Informatique",competences:"javascript,python,react,sql,git,docker,api,agile"},
        {code:"M1806",libelle:"Chef de projet informatique",domaine:"Informatique",competences:"scrum,jalons,budget,cahier des charges"},
        {code:"M1810",libelle:"Administrateur syst√®mes",domaine:"Informatique",competences:"linux,windows,backup,virtualisation"},
        {code:"H1202",libelle:"Charg√© de recrutement",domaine:"RH",competences:"sourcing,entretien,linkedin"},
        {code:"K1101",libelle:"Aide-soignant",domaine:"Sant√©",competences:"soins,hygi√®ne,patient"}
    ];

    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const fileInfo = document.getElementById('fileInfo');
    const anonymizeSwitch = document.getElementById('anonymizeSwitch');
    const jdText = document.getElementById('jdText');
    const loading = document.getElementById('loading');
    const resultSection = document.getElementById('resultSection');
    const notification = document.getElementById('notification');
    const badgesList = document.getElementById('badgesList');

    let currentAnalysis = null;
    let badges = [];

    function showNotification(msg, bg = '#28a745') {
        notification.textContent = msg;
        notification.style.background = bg;
        notification.style.display = 'block';
        setTimeout(() => notification.style.display = 'none', 4000);
    }

    function resetApp() {
        currentAnalysis = null;
        badges = [];
        badgesList.innerHTML = '';
        fileInfo.textContent = '';
        fileInput.value = '';
        jdText.value = '';
        loading.style.display = 'none';
        resultSection.style.display = 'none';
        resultSection.innerHTML = '';
        document.getElementById('jdMatchSection')?.remove();
        document.getElementById('cvModal').style.display = 'none';
        uploadArea.scrollIntoView({behavior:'smooth'});
        showNotification('Pr√™t pour une nouvelle analyse !', '#667eea');
    }

    ['dragenter','dragover'].forEach(e => uploadArea.addEventListener(e, evt => { evt.preventDefault(); uploadArea.classList.add('dragover'); }));
    ['dragleave','drop'].forEach(e => uploadArea.addEventListener(e, () => uploadArea.classList.remove('dragover')));
    uploadArea.addEventListener('drop', e => { e.preventDefault(); const f = e.dataTransfer.files[0]; if (f) handleFile(f); });
    fileInput.addEventListener('change', e => { if (e.target.files[0]) handleFile(e.target.files[0]); });

    function addBadge() {
        const index = badges.length;
        const div = document.createElement('div');
        div.className = 'badge-item';
        div.innerHTML = `
            <input type="text" placeholder="Titre du badge" data-field="title">
            <input type="text" placeholder="√âmetteur" data-field="issuer">
            <input type="text" placeholder="Date (ex: juin 2024)" data-field="date">
            <input type="url" placeholder="Lien de v√©rification" data-field="link">
            <i class="fas fa-trash badge-remove" onclick="removeBadge(this, ${index})"></i>
        `;
        badgesList.appendChild(div);
        badges.push({title:'', issuer:'', date:'', link:''});
    }

    function removeBadge(element, index) {
        element.parentElement.remove();
        badges.splice(index, 1);
    }

    badgesList.addEventListener('input', e => {
        const item = e.target.closest('.badge-item');
        if (!item) return;
        const index = Array.from(badgesList.children).indexOf(item);
        if (index >= 0) {
            const field = e.target.dataset.field;
            badges[index][field] = e.target.value.trim();
        }
    });

    async function extractText(file) {
        const ext = file.name.split('.').pop().toLowerCase();
        const buffer = await file.arrayBuffer();

        if (ext === 'pdf' && window.pdfjsLib) {
            const pdf = await window.pdfjsLib.getDocument({data: buffer}).promise;
            let txt = '';
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                txt += content.items.map(it => it.str).join(' ') + '\n';
            }
            return txt.trim();
        }
        if (ext === 'docx' && window.mammoth) {
            const res = await window.mammoth.extractRawText({arrayBuffer: buffer});
            return res.value.trim();
        }
        if (ext === 'txt') return new TextDecoder().decode(buffer);
        if (['xls','xlsx'].includes(ext) && window.XLSX) {
            const wb = window.XLSX.read(buffer, {type: 'array'});
            return wb.SheetNames.map(n => window.XLSX.utils.sheet_to_txt(wb.Sheets[n])).join('\n').trim();
        }
        throw new Error('Format non support√©');
    }

    function extractName(text) {
        const lines = text.split('\n').slice(0, 20);
        for (let line of lines) {
            const clean = line.trim();
            if (/^[A-Z√Ä√â√à√ä√ã√é√è√î√ñ√ô√õ√ú≈∏][a-z√†√©√®√™√´√Æ√Ø√¥√∂√π√ª√º√ø]+(?:\s+[A-Z√Ä√â√à√ä√ã√é√è√î√ñ√ô√õ√ú≈∏][a-z√†√©√®√™√´√Æ√Ø√¥√∂√π√ª√º√ø]+){1,2}$/.test(clean)) {
                return clean;
            }
        }
        return '';
    }

    function anonymize(text, name) {
        if (!anonymizeSwitch.checked) return text;
        let anon = text
            .replace(/[\w.-]+@[\w.-]+\.\w+/g, '[EMAIL]')
            .replace(/(\+?\d{1,3}[-.\s]?)?\(?\d{2,4}\)?[-.\s]?\d{2,4}[-.\s]?\d{2,4}/g, '[T√âL√âPHONE]')
            .replace(/\d+\s+(?:rue|avenue|bd|boulevard|place|impasse|all√©e|chemin)[^,\n]*/gi, '[ADRESSE]')
            .replace(/\b\d{5}\b/g, '[CP]');
        if (name) name.split(' ').forEach(p => { if (p.length > 2) anon = anon.replace(new RegExp(p, 'gi'), '[NOM]'); });
        return anon;
    }

    function calculateRomeScore(cvText, rome) {
        const cv = cvText.toLowerCase();
        const r = (rome.libelle + ' ' + rome.competences).toLowerCase();
        let score = 0;
        const common = cv.match(/\w{4,}/g)?.filter(w => r.includes(w)) || [];
        score += common.length * 2.5;
        if (cv.includes(rome.code.toLowerCase())) score += 6;
        if (cv.includes(rome.domaine.toLowerCase())) score += 3;
        return Math.min(10, Math.round(score));
    }

    function fetchRomeData(cvText) {
        return romeDatabase.map(r => ({ ...r, score: calculateRomeScore(cvText, r) })).sort((a, b) => b.score - a.score).slice(0, 5);
    }

    async function analyzeCV(raw) {
        const rawName = extractName(raw);
        const lines = raw.split('\n');
        let hook = '';

        const hookPatterns = [/profil/i, /accroche/i, /summary/i, /objectif/i, /√† propos/i, /pr√©sentation/i];
        for (let i = 0; i < Math.min(15, lines.length); i++) {
            const line = lines[i].trim();
            if (hookPatterns.some(p => p.test(line)) && lines[i+1]) {
                hook = lines[i+1].trim();
                if (hook.length > 20) break;
            }
            if (line.length > 50 && line.length < 300 && /[a-zA-Z]/.test(line)) {
                hook = line;
                break;
            }
        }

        if (!hook) {
            hook = "Professionnel rigoureux et passionn√© par les technologies modernes, dot√© d‚Äôune solide exp√©rience en r√©solution de probl√®mes complexes.";
        }

        const text = anonymize(raw, rawName).toLowerCase();

        const sections = ['exp√©rience','formation','comp√©tences','dipl√¥me','langues'].filter(s => text.includes(s)).length;
        const structScore = Math.min(10, Math.round(sections * 1.8 + 2));

        const techDB = ['python','java','javascript','react','sql','git','docker','aws','api','agile'];
        const techFound = techDB.filter(k => text.includes(k));
        const techScore = Math.min(10, Math.round(techFound.length * 0.9 + 1));

        const fmtScore = raw.length > 1000 && raw.length < 12000 ? 9 : 6;

        const years = [...new Set(text.match(/\b(19|20)\d{2}\b/g) || [])].length;
        const chronoScore = Math.min(10, Math.round(years * 1.6));

        const global = Math.round(structScore*0.25 + techScore*0.30 + fmtScore*0.15 + chronoScore*0.30);

        const romeMatches = fetchRomeData(text);
        const closestRome = romeMatches[0];

        const tips = structScore < 7 ? ["Ajoutez des sections claires (Exp√©rience, Formation, Comp√©tences)"] : ["CV bien structur√© !"];
        const softSkills = ['communication','leadership','travail en √©quipe','gestion du temps'].filter(s => text.includes(s));
        const languages = ['anglais','espagnol','allemand','italien'].filter(l => text.includes(l));

        return { rawName, hook, scores: { structScore, techScore, fmtScore, chronoScore, global }, techFound, softSkills, languages, closestRome, romeMatches, tips };
    }

    function displayResults(a) {
        resultSection.innerHTML = `
            <div class="scores-grid">
                <div class="score-card global">
                    <div class="score-label">Score ATS Global</div>
                    <div class="score-value">${a.scores.global}%</div>
                    <div class="score-detail">${a.scores.global >= 80 ? 'Excellent' : '√Ä optimiser'}</div>
                </div>
            </div>

            <h3 class="section-title"><i class="fas fa-chart-bar"></i> Analyse D√©taill√©e (sur 10)</h3>
            <div class="detailed-scores">
                ${['Structure','Techniques','Format','Chronologie'].map((label, i) => {
                    const values = [a.scores.structScore, a.scores.techScore, a.scores.fmtScore, a.scores.chronoScore];
                    const icons = ['fa-layer-group','fa-code','fa-file-alt','fa-calendar-alt'];
                    return `
                        <div class="detail-card">
                            <div class="detail-score">${values[i]}/10</div>
                            <div class="detail-label"><i class="fas ${icons[i]}"></i> ${label}</div>
                            <div class="progress-bar"><div class="progress-fill" style="width:${values[i]*10}%"></div></div>
                        </div>`;
                }).join('')}
            </div>

            <h3 class="section-title"><i class="fas fa-briefcase"></i> Fiche ROME la Plus Proche</h3>
            <div class="card">${a.closestRome ? `<strong>${a.closestRome.code} ‚Äî ${a.closestRome.libelle}</strong><br><span style="color:var(--success);font-weight:700;">Score : ${a.closestRome.score}/10</span>` : 'Aucune fiche ROME d√©tect√©e'}</div>

            <h3 class="section-title"><i class="fas fa-user"></i> Informations Personnelles</h3>
            <div class="card info"><strong>Nom d√©tect√© :</strong> ${anonymizeSwitch.checked ? '[NOM]' : (a.rawName || 'Non d√©tect√©')}</div>

            <h3 class="section-title"><i class="fas fa-lightbulb"></i> Conseils d'Optimisation</h3>
            <div class="card tips">${a.tips.map(t => `<p style="margin:10px 0;">‚úì ${t}</p>`).join('')}</div>

            <h3 class="section-title"><i class="fas fa-building"></i> M√©tiers ROME Correspondants</h3>
            <div class="rome-grid">
                ${a.romeMatches.map(m => `
                    <div class="rome-card">
                        <div class="rome-header"><span class="rome-code">${m.code}</span><span class="rome-score">${m.score}/10</span></div>
                        <div class="rome-body"><strong>${m.libelle}</strong><div class="rome-domaine">${m.domaine}</div></div>
                    </div>
                `).join('')}
            </div>

            <h3 class="section-title"><i class="fas fa-tags"></i> Comp√©tences Identifi√©es</h3>
            <div class="skills-grid">
                ${a.techFound.map(s => `<div class="skill-badge skill-tech">${s.toUpperCase()}</div>`).join('')}
                ${a.softSkills.map(s => `<div class="skill-badge skill-soft">${s}</div>`).join('')}
                ${a.languages.map(l => `<div class="skill-badge skill-lang">${l}</div>`).join('')}
                ${a.techFound.length + a.softSkills.length + a.languages.length === 0 ? '<p style="color:var(--gray-600);">Aucune comp√©tence d√©tect√©e</p>' : ''}
            </div>

            <!-- BOUTONS AJOUT√âS √Ä LA FIN -->
            <div class="action-buttons">
                <button class="btn btn-pdf-report" onclick="downloadReportPDF()">
                    <i class="fas fa-chart-pie"></i> Rapport d‚ÄôAnalyse ATS & ROME
                </button>
                <button class="btn btn-pdf-cv-preview" onclick="openCVEditor()">
                    <i class="fas fa-edit"></i> Personnaliser & T√©l√©charger CV Optimis√©
                </button>
                <button class="btn btn-reset" onclick="resetApp()">
                    <i class="fas fa-sync"></i> Nouveau
                </button>
            </div>
        `;

        resultSection.style.display = 'block';
        resultSection.scrollIntoView({behavior:'smooth'});
    }

    async function handleFile(file) {
        fileInfo.textContent = `Fichier : ${file.name}`;
        loading.style.display = 'block';
        resultSection.style.display = 'none';
        try {
            const raw = await extractText(file);
            if (!raw.trim()) throw new Error('CV vide');
            const analysis = await analyzeCV(raw);
            currentAnalysis = analysis;
            displayResults(analysis);
            showNotification('Analyse termin√©e avec succ√®s !');
        } catch (err) {
            showNotification('Erreur : ' + err.message, '#dc3545');
        } finally {
            loading.style.display = 'none';
        }
    }

    // === Fonctions PDF et √©diteur identiques aux versions pr√©c√©dentes (avec waitForLibraries) ===

    async function waitForLibraries() {
        let attempts = 0;
        while (attempts < 30) {
            if (window.html2canvas && window.jspdf && window.jspdf.jsPDF) return true;
            await new Promise(r => setTimeout(r, 500));
            attempts++;
        }
        return false;
    }

    async function downloadReportPDF() {
        if (!currentAnalysis) return showNotification('Aucune analyse', '#dc3545');
        showNotification('Chargement des outils...', '#667eea');
        if (!(await waitForLibraries())) return showNotification('Outils non charg√©s', '#dc3545');
        const canvas = await html2canvas(resultSection, {scale: 2, backgroundColor: '#ffffff'});
        const imgData = canvas.toDataURL('image/png');
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF(canvas.width > canvas.height ? 'l' : 'p', 'px', [canvas.width, canvas.height]);
        pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
        pdf.save('RUNIC_PRO_Rapport_Analyse.pdf');
        showNotification('Rapport t√©l√©charg√© !', '#28a745');
    }

    function openCVEditor() {
        if (!currentAnalysis) return showNotification('Chargez un CV', '#ffc107');
        // ... (code de l'√©diteur identique)
    }

    // Le reste du code (closeCVEditor, downloadCVFromPreview, analyzeWithJD) est le m√™me que dans les versions pr√©c√©dentes

</script>
</body>
</html>