<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RUNIC - Analyseur ATS + ROME 4.0</title>

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Montserrat:wght@600;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>

    <style>
        :root {
            --primary: #667eea; --primary-dark: #764ba2; --success: #28a745; --danger: #dc3545;
            --gray-100: #f8f9ff; --gray-200: #e2e8f0; --gray-600: #6c757d; --radius: 16px; --shadow: 0 8px 25px rgba(102,126,234,.2);
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body {font-family:'Roboto',sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);padding:20px;color:#333;min-height:100vh;}
        .container {max-width:1200px;margin:0 auto;background:white;border-radius:var(--radius);box-shadow:0 20px 60px rgba(0,0,0,.3);overflow:hidden;}
        header {background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);color:white;padding:40px;text-align:center;}
        header h1 {font-family:'Montserrat',sans-serif;font-size:clamp(2.5em,7vw,4em);font-weight:800;}
        header p {font-size:1.3em;margin-top:10px;opacity:.95;}

        main {padding:40px;}

        .upload-section, .jd-section, .badges-section {
            padding:30px;border:2px solid var(--primary);border-radius:var(--radius);background:#fff;margin-bottom:30px;box-shadow:var(--shadow);
        }
        .upload-section h2, .jd-section h2, .badges-section h2 {color:var(--primary);margin-bottom:20px;font-family:'Montserrat',sans-serif;font-size:1.6em;}

        .upload-btn, .jd-btn, .badge-add-btn {
            background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);color:white;padding:14px 32px;border:none;border-radius:30px;
            cursor:pointer;font-weight:700;font-size:1.1em;transition:all .3s;box-shadow:0 6px 20px rgba(102,126,234,.4);
        }
        .upload-btn:hover, .jd-btn:hover, .badge-add-btn:hover {transform:translateY(-3px);box-shadow:0 10px 30px rgba(102,126,234,.5);}

        textarea {width:100%;padding:15px;border:2px solid var(--gray-200);border-radius:12px;min-height:160px;font-size:1.1em;}
        textarea:focus {outline:none;border-color:var(--primary);box-shadow:0 0 0 4px rgba(102,126,234,.15);}

        .badge-item {display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin:15px 0;padding:15px;background:var(--gray-100);border-radius:12px;}
        .badge-item input {flex:1;min-width:200px;padding:12px;border:1px solid var(--gray-200);border-radius:10px;font-size:1em;}
        .badge-remove {color:var(--danger);cursor:pointer;font-size:1.6em;transition:all .3s;}
        .badge-remove:hover {transform:scale(1.2);}

        .loading {text-align:center;padding:80px;display:none;}
        .spinner {width:70px;height:70px;border:8px solid #f3f3f3;border-top:8px solid var(--primary);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 30px;}
        @keyframes spin {to{transform:rotate(360deg)}}

        .result-section {display:none;padding:40px;background:var(--gray-100);border-radius:20px;}
        .action-buttons {text-align:center;margin:60px 0;display:flex;gap:20px;justify-content:center;flex-wrap:wrap;}
        .btn {padding:18px 40px;border-radius:35px;font-size:1.2em;font-weight:700;display:flex;align-items:center;gap:15px;box-shadow:0 8px 25px rgba(0,0,0,.3);transition:all .3s;}
        .btn:hover {transform:translateY(-5px);}

        .pdf-container {display:none;background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);color:white;padding:40px;font-family:'Roboto',sans-serif;}
        .pdf-container h1 {font-family:'Montserrat',sans-serif;font-size:2.8em;text-align:center;margin-bottom:20px;}
        .pdf-container .subtitle {font-size:1.4em;text-align:center;font-style:italic;margin-bottom:40px;max-width:90%;margin-left:auto;margin-right:auto;}
        .pdf-container .radar {max-width:600px;margin:40px auto;background:white;padding:30px;border-radius:20px;}
        .pdf-container .section {margin:40px 0;}
        .pdf-container .section h3 {font-size:1.8em;margin-bottom:20px;text-align:center;}
        .pdf-container ul {list-style:none;max-width:800px;margin:0 auto;}
        .pdf-container li {margin:15px 0;padding:20px;background:rgba(255,255,255,0.2);border-radius:12px;font-size:1.1em;}
        .pdf-container .footer {text-align:center;margin-top:80px;padding-top:20px;border-top:1px solid rgba(255,255,255,0.3);font-size:1em;opacity:0.9;}

        .info-modal {display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:1000;align-items:center;justify-content:center;}
        .info-modal-content {background:white;border-radius:20px;max-width:700px;width:90%;padding:40px;box-shadow:0 30px 80px rgba(0,0,0,.4);text-align:center;}
        .info-modal-content input, .info-modal-content textarea {width:100%;margin:15px 0;padding:15px;border:2px solid var(--gray-200);border-radius:10px;font-size:1.2em;}
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>RUNIC</h1>
        <p>Analyseur ATS + ROME 4.0</p>
    </header>

    <main>
        <div class="upload-section">
            <h2>Chargez votre CV</h2>
            <input type="file" id="fileInput" accept=".pdf,.docx,.txt" style="display:none;">
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">S√©lectionner le CV</button>
        </div>

        <div class="jd-section">
            <h2>Offre d'Emploi (optionnel)</h2>
            <textarea id="jdText" placeholder="Collez ici le texte de l'offre pour analyser la compatibilit√©"></textarea>
        </div>

        <div class="badges-section">
            <h2>üèÖ Open Badges (optionnel)</h2>
            <button class="badge-add-btn" onclick="addBadge()">+ Ajouter un badge</button>
            <div id="badgesList"></div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Analyse en cours...</p>
        </div>

        <div class="result-section" id="resultSection"></div>
    </main>
</div>

<!-- Modale personnalisation PDF -->
<div class="info-modal" id="infoModal">
    <div class="info-modal-content">
        <h2>Personnalisez votre PDF</h2>
        <input type="text" id="pdfName" placeholder="Nom Pr√©nom">
        <textarea id="pdfHook" placeholder="Phrase d'accroche"></textarea>
        <button class="btn" onclick="generateSelectedPDF()">G√©n√©rer</button>
    </div>
</div>

<!-- Conteneurs PDF cach√©s -->
<div id="passeportPDF" class="pdf-container">
    <h1>Le passeport de competence</h1>
    <div class="subtitle" id="passeportSubtitle"></div>
    <div class="radar"><canvas id="passeportRadar"></canvas></div>
    <div class="section badges">
        <h3>Open Badges</h3>
        <ul id="passeportBadges"></ul>
    </div>
    <div class="section metiers">
        <h3>M√©tiers pertinents</h3>
        <ul id="passeportMetiers"></ul>
    </div>
    <div class="footer">RUNIC ‚Ä¢ Cr√©√© par C√©dric Odin</div>
</div>

<div id="atsPDF" class="pdf-container">
    <h1>Analyse ATS</h1>
    <div class="subtitle" id="atsSubtitle"></div>
    <div class="radar"><canvas id="atsRadar"></canvas></div>
    <div class="section badges">
        <h3>Open Badges</h3>
        <ul id="atsBadges"></ul>
    </div>
    <div class="section romes">
        <h3>Fiches ROME compatibles</h3>
        <ul id="atsRomes"></ul>
    </div>
    <div class="section missing" id="atsMissing" style="display:none;">
        <h3>Points manquants & Axes d‚Äôam√©lioration</h3>
        <ul id="atsPoints"></ul>
    </div>
    <div class="footer">RUNIC ‚Ä¢ Cr√©√© par C√©dric Odin</div>
</div>

<script>
    // === CONFIG API (ligne 47) ===
    const FT_CLIENT_ID = "PAR_runicats_4c5356704feaa3323073c02ba2bc8ab39976b234cdfdc3cd910a1a5698cd00c3";
    const FT_CLIENT_SECRET = "bc0994e1a9c66bc2cbfa0fd8be773159e8fc0566961b84d3d2e32991c69c1b99"; 

    let token = null;
    let cvData = null;
    let romeMatches = [];
    let badges = [];
    let pdfType = '';
    let jdTextValue = '';

    async function getToken() {
        if (token) return token;
        const res = await fetch("https://entreprise.francetravail.fr/connexion/oauth2/access_token?realm=/partenaire", {
            method: "POST",
            headers: {"Content-Type": "application/x-www-form-urlencoded"},
            body: new URLSearchParams({
                grant_type: "client_credentials",
                client_id: FT_CLIENT_ID,
                client_secret: FT_CLIENT_SECRET,
                scope: "api_romev1"
            })
        });
        const data = await res.json();
        token = data.access_token;
        return token;
    }

    async function extractText(file) {
        const buffer = await file.arrayBuffer();
        const ext = file.name.split('.').pop().toLowerCase();

        if (ext === 'pdf' && window.pdfjsLib) {
            const pdf = await pdfjsLib.getDocument({data: buffer}).promise;
            let text = '';
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                const items = content.items.map(item => ({str: item.str.trim(), y: Math.round(item.transform[5])})).filter(i => i.str);
                items.sort((a, b) => b.y - a.y);
                let line = '';
                let lastY = null;
                for (const item of items) {
                    if (lastY === null || Math.abs(item.y - lastY) > 15) {
                        if (line) text += line + '\n';
                        line = item.str;
                    } else line += ' ' + item.str;
                    lastY = item.y;
                }
                if (line) text += line + '\n\n';
            }
            return text.trim();
        }

        if (ext === 'docx' && window.mammoth) {
            const result = await mammoth.extractRawText({arrayBuffer: buffer});
            return result.value.trim();
        }

        if (ext === 'txt') {
            return new TextDecoder().decode(buffer);
        }

        throw new Error('Format non support√©');
    }

    function parseCV(text) {
        const lines = text.split('\n').map(l => l.trim()).filter(l => l);
        const cv = {nom: lines[0] || '', accroche: '', competences: [], experiences: [], formations: []};
        let section = '';
        for (let line of lines) {
            if (line.match(/convaincu.*aventure collective/i)) cv.accroche = line;
            if (/comp√©tences/i.test(line)) section = 'competences';
            if (/parcours/i.test(line)) section = 'experiences';
            if (/formations/i.test(line)) section = 'formations';
            if (section === 'competences' && line.startsWith('‚Ä¢')) cv.competences.push(line.slice(1).trim());
        }
        return cv;
    }

    async function getRomeMatches(text) {
        const token = await getToken();
        const query = encodeURIComponent(text.substring(0, 500));
        const res = await fetch(`https://api.francetravail.io/partenaire/rome/v1/metiers/recherche?motCle=${query}`, {headers: {Authorization: `Bearer ${token}`}});
        const data = await res.json();
        const matches = [];
        for (const m of data.slice(0, 10)) {
            const detail = await getDetailMetier(m.code);
            let score = 0;
            const lower = text.toLowerCase();
            if (lower.includes(detail.libelle.toLowerCase())) score += 40;
            (detail.appellations || []).forEach(a => lower.includes(a.toLowerCase()) && (score += 20));
            (detail.competences || []).forEach(c => lower.includes(c.libelle.toLowerCase()) && (score += 10));
            if (score >= 65) matches.push({code: m.code, libelle: detail.libelle, score});
        }
        return matches.sort((a,b) => b.score - a.score).slice(0,5);
    }

    async function getDetailMetier(code) {
        const token = await getToken();
        const res = await fetch(`https://api.francetravail.io/partenaire/rome/v1/metier/${code}`, {headers: {Authorization: `Bearer ${token}`}});
        return await res.json();
    }

    function addBadge() {
        const div = document.createElement('div');
        div.className = 'badge-item';
        div.innerHTML = `
            <input type="text" placeholder="Titre">
            <input type="text" placeholder="√âmetteur">
            <input type="text" placeholder="Date">
            <input type="url" placeholder="Lien">
            <i class="fas fa-trash badge-remove" onclick="this.parentElement.remove()"></i>
        `;
        document.getElementById('badgesList').appendChild(div);
    }

    function createRadar(id) {
        new Chart(document.getElementById(id), {
            type: 'radar',
            data: {labels: ['√âcoute active','Empathie','R√©seaux','Coop√©ration','Adaptabilit√©','Organisation','Communication','R√©silience'],
                datasets: [{data: [9.5,9.5,9.6,9.2,9.0,9.3,8.8,9.0], backgroundColor: 'rgba(102,126,234,0.35)', borderColor: 'white'}]
            },
            options: {scales: {r: {max:10}}}
        });
    }

    async function generatePDF(elementId, filename) {
        const el = document.getElementById(elementId);
        el.style.display = 'block';
        const canvas = await html2canvas(el, {scale: 2});
        el.style.display = 'none';
        const img = canvas.toDataURL('image/png');
        const {jsPDF} = window.jspdf;
        const pdf = new jsPDF('p','mm','a4');
        pdf.addImage(img, 'PNG', 0, 0, 210, 297);
        pdf.save(filename);
    }

    function openPDFModal(type) {
        pdfType = type;
        document.getElementById('pdfName').value = cvData.nom;
        document.getElementById('pdfHook').value = cvData.accroche;
        document.getElementById('infoModal').style.display = 'flex';
    }

    function generateSelectedPDF() {
        const name = document.getElementById('pdfName').value || cvData.nom;
        const hook = document.getElementById('pdfHook').value || cvData.accroche;
        document.getElementById('infoModal').style.display = 'none';

        if (pdfType === 'passeport') {
            document.getElementById('passeportSubtitle').textContent = `${name} ‚Äî ${hook}`;
            const bList = document.getElementById('passeportBadges');
            bList.innerHTML = badges.length ? badges.map(b => `<li>${b.title || ''} - ${b.issuer || ''}</li>`).join('') : '<li>Aucun badge ajout√© ‚Äì Ajoutez-en pour renforcer votre profil !</li>';
            document.getElementById('passeportMetiers').innerHTML = romeMatches.map(m => `<li>${m.libelle}</li>`).join('');
            createRadar('passeportRadar');
            generatePDF('passeportPDF', 'Le_passeport_de_competence.pdf');
        } else {
            document.getElementById('atsSubtitle').textContent = `${name} ‚Äî ${hook}`;
            document.getElementById('atsBadges').innerHTML = document.getElementById('passeportBadges').innerHTML;
            document.getElementById('atsRomes').innerHTML = romeMatches.map(m => `<li>${m.libelle} (${m.score}%)</li>`).join('');
            createRadar('atsRadar');
            if (jdTextValue) {
                document.getElementById('atsMissing').style.display = 'block';
                document.getElementById('atsPoints').innerHTML = '<li>Exemple : Renforcer les mots-cl√©s de l\'offre dans votre CV</li>';
            } else {
                document.getElementById('atsMissing').style.display = 'none';
            }
            generatePDF('atsPDF', 'Analyse_ATS.pdf');
        }
    }

    async function handleFile(file) {
        document.getElementById('loading').style.display = 'block';
        jdTextValue = document.getElementById('jdText').value.trim();
        const text = await extractText(file);
        cvData = parseCV(text);
        romeMatches = await getRomeMatches(text);
        document.getElementById('resultSection').innerHTML = `
            <div class="action-buttons">
                <button class="btn" onclick="openPDFModal('passeport')">Le passeport de competence</button>
                <button class="btn" onclick="openPDFModal('ats')">Analyse ATS</button>
            </div>
        `;
        document.getElementById('resultSection').style.display = 'block';
        document.getElementById('loading').style.display = 'none';
    }

    document.getElementById('fileInput').addEventListener('change', e => e.target.files[0] && handleFile(e.target.files[0]));
</script>
</body>
</html>
