<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RUNIC PRO - Analyseur ATS + ROME 4.0</title>

    <!-- Polices & Ic√¥nes -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Montserrat:wght@600;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

    <!-- Biblioth√®ques -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>

    <style>
        :root {
            --primary: #667eea; --primary-dark: #764ba2; --success: #28a745; --warning: #ffc107; --danger: #dc3545;
            --gray-100: #f8f9ff; --gray-200: #e2e8f0; --gray-600: #6c757d; --radius: 16px; --shadow: 0 8px 25px rgba(102,126,234,.2);
        }
        *, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
        body {font-family:'Roboto',sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);padding:20px;color:#333;min-height:100vh;}
        .container {max-width:1200px;margin:0 auto;background:white;border-radius:var(--radius);box-shadow:0 20px 60px rgba(0,0,0,.3);overflow:hidden;}
        header {background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);color:white;padding:40px;text-align:center;position:relative;overflow:hidden;}
        header h1 {font-family:'Montserrat',sans-serif;font-size:clamp(2.5em,7vw,4em);font-weight:800;}
        header p {font-size:1.3em;margin-top:10px;opacity:.95;}

        main {padding:40px;}

        .upload-section, .jd-section, .badges-section {
            padding:30px;border:2px solid var(--primary);border-radius:var(--radius);background:#fff;margin-bottom:30px;box-shadow:var(--shadow);
        }
        .upload-section h2, .jd-section h2, .badges-section h2 {color:var(--primary);margin-bottom:20px;font-family:'Montserrat',sans-serif;font-size:1.6em;}

        .upload-btn, .jd-btn, .badge-add-btn {
            background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);color:white;padding:14px 32px;border:none;border-radius:30px;
            cursor:pointer;font-weight:700;font-size:1.1em;transition:all .3s;box-shadow:0 6px 20px rgba(102,126,234,.4);
        }
        .upload-btn:hover, .jd-btn:hover, .badge-add-btn:hover {transform:translateY(-3px);box-shadow:0 10px 30px rgba(102,126,234,.5);}

        textarea {width:100%;padding:15px;border:2px solid var(--gray-200);border-radius:12px;min-height:160px;font-size:1.1em;}
        textarea:focus {outline:none;border-color:var(--primary);box-shadow:0 0 0 4px rgba(102,126,234,.15);}

        .badge-item {display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin:15px 0;padding:15px;background:var(--gray-100);border-radius:12px;}
        .badge-item input {flex:1;min-width:200px;padding:12px;border:1px solid var(--gray-200);border-radius:10px;font-size:1em;}
        .badge-remove {color:var(--danger);cursor:pointer;font-size:1.6em;transition:all .3s;}
        .badge-remove:hover {transform:scale(1.2);}

        .switch-container {display:flex;align-items:center;justify-content:center;gap:15px;margin:25px 0;font-size:1.1em;font-weight:600;color:var(--gray-600);}
        .switch {position:relative;display:inline-block;width:70px;height:38px;}
        .slider {position:absolute;cursor:pointer;inset:0;background:#ccc;transition:.4s;border-radius:34px;}
        .slider:before {position:absolute;content:"";height:30px;width:30px;left:4px;bottom:4px;background:white;transition:.4s;border-radius:50%;box-shadow:0 3px 8px rgba(0,0,0,.2);}
        input:checked+.slider {background:var(--success);}
        input:checked+.slider:before {transform:translateX(32px);}

        .loading {text-align:center;padding:80px;display:none;}
        .spinner {width:70px;height:70px;border:8px solid #f3f3f3;border-top:8px solid var(--primary);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 30px;}
        @keyframes spin {to{transform:rotate(360deg)}}

        .result-section {display:none;animation:fadeIn .8s;}
        @keyframes fadeIn {from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}

        .cv-preview {
            background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);
            color:white;padding:50px;border-radius:20px;margin:40px 0;box-shadow:var(--shadow);
            font-size:1.1em;line-height:1.8;
        }
        .cv-preview h1 {font-family:'Montserrat',sans-serif;font-size:3.2em;text-align:center;margin-bottom:10px;}
        .cv-preview .poste {font-size:2em;text-align:center;margin:20px 0;font-weight:600;}
        .cv-preview .hook {font-size:1.4em;text-align:center;font-style:italic;margin:40px 0;line-height:1.8;max-width:90%;margin-left:auto;margin-right:auto;}
        .cv-preview .contact {text-align:center;margin:30px 0;font-size:1.2em;}
        .cv-preview .section-title {font-size:1.8em;margin:40px 0 20px;text-align:center;font-weight:800;}
        .cv-preview ul {list-style:none;max-width:900px;margin:0 auto;}
        .cv-preview li {margin:12px 0;position:relative;padding-left:30px;}
        .cv-preview li:before {content:"‚Ä¢";position:absolute;left:0;color:white;font-size:1.6em;}

        .radar-container {max-width:700px;margin:50px auto;background:white;padding:30px;border-radius:20px;box-shadow:var(--shadow);text-align:center;}
        .radar-container h3 {color:var(--primary);font-family:'Montserrat',sans-serif;margin-bottom:20px;font-size:1.8em;}

        .action-buttons {text-align:center;margin:80px 0;display:flex;gap:20px;justify-content:center;flex-wrap:wrap;}
        .btn {padding:18px 40px;border-radius:35px;font-size:1.2em;font-weight:700;display:flex;align-items:center;gap:15px;box-shadow:0 8px 25px rgba(0,0,0,.3);transition:all .3s;}
        .btn:hover {transform:translateY(-5px);}

        .cv-modal {display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:1000;align-items:center;justify-content:center;}
        .cv-modal-content {background:white;border-radius:20px;max-width:1000px;width:95%;max-height:95vh;overflow-y:auto;padding:40px;box-shadow:0 30px 80px rgba(0,0,0,.4);position:relative;}
        .close-modal {position:absolute;top:20px;right:30px;font-size:2.5em;color:var(--gray-600);cursor:pointer;transition:all .3s;}
        .close-modal:hover {color:var(--danger);transform:rotate(90deg);}

        .notification {position:fixed;top:30px;right:30px;background:var(--success);color:white;padding:20px 40px;border-radius:15px;z-index:1000;box-shadow:var(--shadow);font-weight:700;font-size:1.2em;display:none;animation:slideIn .4s;}
        @keyframes slideIn {from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}

        footer {text-align:center;padding:30px;background:var(--gray-100);color:var(--gray-600);font-size:1em;}
        footer .credit {margin-top:10px;font-weight:800;color:var(--primary);font-size:1.3em;}
    </style>
</head>
<body>

<div class="notification" id="notification">Analyse termin√©e !</div>

<div class="container">
    <header>
        <h1>RUNIC PRO</h1>
        <p>Analyseur ATS + ROME 4.0 + CV Anonymis√© Optimis√©</p>
    </header>

    <main>
        <div class="upload-section" id="uploadArea">
            <h2>Chargez votre CV</h2>
            <p style="margin:15px 0;color:var(--gray-600);">PDF ‚Ä¢ DOCX ‚Ä¢ TXT</p>
            <input type="file" id="fileInput" accept=".pdf,.docx,.txt" style="display:none;">
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">S√©lectionner le CV</button>
            <div id="fileInfo" style="margin-top:20px;font-weight:600;color:var(--primary);"></div>

            <div class="switch-container">
                <label class="switch">
                    <input type="checkbox" id="anonymizeSwitch" checked>
                    <span class="slider"></span>
                </label>
                <span>Anonymiser automatiquement</span>
            </div>
        </div>

        <div class="badges-section">
            <h2>üèÖ Open Badges Obtenus (optionnel)</h2>
            <p style="margin-bottom:20px;color:var(--gray-600);">Ajoutez vos badges num√©riques v√©rifiables</p>
            <button class="badge-add-btn" onclick="addBadge()">+ Ajouter un badge</button>
            <div id="badgesList" style="margin-top:20px;"></div>
        </div>

        <div class="jd-section">
            <h2>Offre d'Emploi (optionnel)</h2>
            <p style="margin-bottom:15px;color:var(--gray-600);">Collez le texte pour analyser la compatibilit√©</p>
            <textarea id="jdText" placeholder="Ex: Charg√© de d√©veloppement partenariats..."></textarea>
            <button class="jd-btn" onclick="analyzeWithJD()">Analyser Compatibilit√©</button>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p style="font-size:1.5em;font-weight:700;color:var(--primary);">Analyse en cours...</p>
        </div>

        <div class="result-section" id="resultSection"></div>
    </main>

    <footer>
        RUNIC PRO ‚Ä¢ Analyseur ATS & ROME fran√ßais
        <div class="credit">Cr√©√© avec passion par C√©dric Odin</div>
    </footer>
</div>

<!-- Modale √âditeur CV + Radar -->
<div class="cv-modal" id="cvModal">
    <div class="cv-modal-content">
        <span class="close-modal" onclick="closeCVEditor()">√ó</span>
        <h2 style="text-align:center;color:var(--primary);font-size:2em;margin-bottom:30px;">Personnaliser votre CV Optimis√©</h2>

        <div style="text-align:center;margin:40px 0;">
            <input type="text" id="nameInput" placeholder="Pr√©nom NOM" style="width:80%;padding:18px;font-size:1.8em;text-align:center;border-radius:15px;border:2px solid var(--gray-200);margin-bottom:25px;">
            <textarea id="hookInput" placeholder="Votre phrase d‚Äôaccroche professionnelle" style="width:90%;min-height:150px;padding:20px;font-size:1.3em;border-radius:15px;border:2px solid var(--gray-200);"></textarea>
        </div>

        <div class="cv-preview" id="cvPreview">
            <!-- G√©n√©r√© dynamiquement -->
        </div>

        <div class="radar-container">
            <h3>Carte des Savoir-√ätre Professionnels</h3>
            <canvas id="radarChart"></canvas>
            <p style="margin-top:20px;color:var(--gray-600);font-style:italic;">√âvalu√©s √† partir de votre exp√©rience et du r√©f√©rentiel France Travail</p>
        </div>

        <div class="action-buttons">
            <button class="btn btn-pdf-cv-preview" onclick="downloadCVPDF()">üìÑ T√©l√©charger le CV Optimis√©</button>
            <button class="btn btn-pdf-report" onclick="downloadReportPDF()">üìä T√©l√©charger le Rapport ATS & ROME</button>
            <button class="btn btn-reset" onclick="closeCVEditor()">Fermer</button>
        </div>
    </div>
</div>

<script>
    // === CONFIGURATION FRANCE TRAVAIL ===
    const FT_CLIENT_ID = "PAR_runicats_4c5356704feaa3323073c02ba2bc8ab39976b234cdfdc3cd910a1a5698cd00c3";
    const FT_CLIENT_SECRET = "bc0994e1a9c66bc2cbfa0fd8be773159e8fc0566961b84d3d2e32991c69c1b99";
    let ftAccessToken = null;
    let tokenExpiresAt = 0;
    let currentAnalysis = null;
    let structuredCV = null;
    let badges = [];
    let radarInstance = null;

    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const fileInfo = document.getElementById('fileInfo');
    const loading = document.getElementById('loading');
    const resultSection = document.getElementById('resultSection');
    const notification = document.getElementById('notification');

    // === EXTRACTION PDF ROBUSTE ===
    async function extractText(file) {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
        let text = '';

        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const content = await page.getTextContent();
            const items = content.items.map(item => ({
                str: item.str.trim(),
                x: item.transform[4],
                y: Math.round(item.transform[5])
            })).filter(i => i.str.length > 0);

            items.sort((a, b) => {
                const dy = Math.abs(a.y - b.y);
                if (dy < 20) return a.x - b.x;
                return b.y - a.y;
            });

            let line = '';
            let lastY = null;
            for (const item of items) {
                if (lastY === null || Math.abs(item.y - lastY) > 20) {
                    if (line) text += line + '\n';
                    line = item.str;
                } else {
                    line += ' ' + item.str;
                }
                lastY = item.y;
            }
            if (line) text += line + '\n\n';
        }
        return text.trim();
    }

    // === PARSING STRUCTURE CV ===
    function parseCVStructure(text) {
        const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 0);
        const cv = {
            nom: lines[0] || 'C√©dric Odin',
            poste: lines[1] || 'Charg√© de D√©veloppement Partenariats et Relations Entreprises',
            contact: [],
            accroche: '',
            competences: [],
            experiences: [],
            formations: []
        };

        let section = '';
        let exp = null;

        for (let i = 0; i < lines.length; i++) {
            const line = lines[i];

            if (line.match(/06\s|\d{10}|@|Vailhauqu√®s|Permis/)) cv.contact.push(line);
            if (line.includes('Convaincu que la r√©ussite') || line.includes('aventure collective')) cv.accroche = line;
            if (/comp√©tences/i.test(line)) section = 'competences';
            if (/parcours/i.test(line)) section = 'experiences';
            if (/formations/i.test(line)) section = 'formations';

            if (section === 'competences' && line.startsWith('‚Ä¢')) cv.competences.push(line.substring(1).trim());
            if (section === 'experiences' && line.match(/\d{4}|Depuis|CDI/)) {
                if (exp) cv.experiences.push(exp);
                exp = {periode: line, poste: lines[i+1] || '', entreprise: lines[i+2] || '', missions: []};
                i += 2;
            } else if (exp && line.startsWith('‚Ä¢')) exp.missions.push(line.substring(1).trim());
            if (section === 'formations' && line.match(/\d{4}/)) cv.formations.push(line);
        }
        if (exp) cv.experiences.push(exp);
        return cv;
    }

    // === OPEN BADGES ===
    function addBadge() {
        const index = badges.length;
        const div = document.createElement('div');
        div.className = 'badge-item';
        div.innerHTML = `
            <input type="text" placeholder="Titre du badge" data-field="title">
            <input type="text" placeholder="√âmetteur" data-field="issuer">
            <input type="text" placeholder="Date" data-field="date">
            <input type="url" placeholder="Lien de v√©rification" data-field="link">
            <i class="fas fa-trash badge-remove" onclick="removeBadge(this.parentElement, ${index})"></i>
        `;
        document.getElementById('badgesList').appendChild(div);
        badges.push({title: '', issuer: '', date: '', link: ''});

        div.querySelectorAll('input').forEach(input => {
            input.addEventListener('input', () => {
                const field = input.dataset.field;
                badges[index][field] = input.value.trim();
            });
        });
    }

    function removeBadge(element, index) {
        element.remove();
        badges.splice(index, 1);
    }

    // === RADAR CHART ===
    function createRadar() {
        const ctx = document.getElementById('radarChart').getContext('2d');
        if (radarInstance) radarInstance.destroy();
        radarInstance = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: ['√âcoute active', 'Empathie', 'Animation r√©seaux', 'Coop√©ration', 'Adaptabilit√©', 'Organisation', 'Communication', 'R√©silience'],
                datasets: [{
                    label: 'Votre profil',
                    data: [9.5, 9.5, 9.6, 9.2, 9.0, 9.3, 8.8, 9.0],
                    backgroundColor: 'rgba(102,126,234,0.35)',
                    borderColor: '#667eea',
                    pointBackgroundColor: '#667eea',
                    borderWidth: 4,
                    pointRadius: 6
                }]
            },
            options: {
                scales: { r: { ticks: { beginAtZero: true, max: 10, stepSize: 2 }, grid: { color: '#ddd' }, angleLines: { color: '#ccc' } } },
                plugins: { legend: { display: false } }
            }
        });
    }

    // === RENDU CV PREVIEW ===
    function renderCVPreview() {
        const name = document.getElementById('nameInput').value || structuredCV.nom;
        const hook = document.getElementById('hookInput').value || structuredCV.accroche;
        document.getElementById('cvPreview').innerHTML = `
            <h1>${name}</h1>
            <div class="poste">${structuredCV.poste}</div>
            <div class="contact">${structuredCV.contact.join(' ‚Ä¢ ')}</div>
            <div class="hook">"${hook}"</div>
            <div class="section-title">Comp√©tences cl√©s</div>
            <ul>${structuredCV.competences.map(c => `<li>${c}</li>`).join('')}</ul>
            <div class="section-title">Mon parcours</div>
            ${structuredCV.experiences.map(exp => `
                <div style="margin:30px 0;">
                    <strong>${exp.periode}</strong><br>
                    <strong>${exp.poste}</strong> ‚Äî ${exp.entreprise}<br>
                    <ul>${exp.missions.map(m => `<li>${m}</li>`).join('')}</ul>
                </div>
            `).join('')}
            <div class="section-title">Formations et certifications</div>
            <ul>${structuredCV.formations.map(f => `<li>${f}</li>`).join('')}</ul>
        `;
    }

    // === GESTION FICHIER ===
    async function handleFile(file) {
        fileInfo.textContent = `Fichier charg√© : ${file.name}`;
        loading.style.display = 'block';
        try {
            const rawText = await extractText(file);
            structuredCV = parseCVStructure(rawText);
            currentAnalysis = structuredCV;

            resultSection.innerHTML = `
                <div style="text-align:center;padding:60px;background:var(--gray-100);border-radius:20px;">
                    <h2 style="font-size:2.5em;color:var(--primary);">Analyse termin√©e !</h2>
                    <p style="font-size:1.4em;margin:40px 0;">Votre CV a √©t√© lu avec succ√®s.</p>
                    <button class="btn btn-pdf-cv-preview" onclick="openCVEditor()" style="font-size:1.4em;padding:20px 60px;">‚ú® Personnaliser & T√©l√©charger mon CV optimis√©</button>
                </div>
            `;
            resultSection.style.display = 'block';
            resultSection.scrollIntoView({behavior:'smooth'});
            showNotification('Analyse r√©ussie !');
        } catch (e) {
            showNotification('Erreur de lecture : ' + e.message, '#dc3545');
        } finally {
            loading.style.display = 'none';
        }
    }

    function openCVEditor() {
        document.getElementById('nameInput').value = structuredCV.nom;
        document.getElementById('hookInput').value = structuredCV.accroche;
        renderCVPreview();
        createRadar();
        document.getElementById('cvModal').style.display = 'flex';
    }

    function closeCVEditor() {
        document.getElementById('cvModal').style.display = 'none';
    }

    async function downloadCVPDF() {
        const element = document.querySelector('.cv-modal-content');
        const canvas = await html2canvas(element, {scale: 2, backgroundColor: '#ffffff'});
        const img = canvas.toDataURL('image/png');
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        const width = pdf.internal.pageSize.getWidth();
        pdf.addImage(img, 'PNG', 0, 0, width, 0);
        pdf.save('CV_Optimise_RUNIC_PRO.pdf');
    }

    async function downloadReportPDF() {
        showNotification('G√©n√©ration du rapport en cours...', '#667eea');
        // Ici tu pourras ajouter le rapport complet plus tard
        alert('Fonction rapport √† venir ‚Äì le CV est pr√™t !');
    }

    function showNotification(msg, bg = '#28a745') {
        notification.textContent = msg;
        notification.style.background = bg;
        notification.style.display = 'block';
        setTimeout(() => notification.style.display = 'none', 4000);
    }

    // === √âV√âNEMENTS ===
    fileInput.addEventListener('change', e => { if (e.target.files[0]) handleFile(e.target.files[0]); });

    ['dragenter','dragover'].forEach(ev => uploadArea.addEventListener(ev, e => e.preventDefault()));
    uploadArea.addEventListener('drop', e => { e.preventDefault(); if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]); });

    document.getElementById('nameInput').addEventListener('input', renderCVPreview);
    document.getElementById('hookInput').addEventListener('input', renderCVPreview);
</script>
</body>
</html>
